<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tailoring Shop Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .input-style {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .summary-card {
            @apply p-4 rounded-xl shadow-lg transition-all duration-300 hover:shadow-xl;
        }
        .status-badge {
            @apply px-2 py-1 rounded-full text-xs font-medium;
        }
        .status-pending { @apply bg-yellow-100 text-yellow-800; }
        .status-in-progress { @apply bg-blue-100 text-blue-800; }
        .status-completed { @apply bg-green-100 text-green-800; }
        .status-delivered { @apply bg-purple-100 text-purple-800; }
        .status-review { @apply bg-red-100 text-red-800; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1001;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .notification.success {
            background-color: #10b981;
        }
        .notification.error {
            background-color: #ef4444;
        }
        .notification.warning {
            background-color: #f59e0b;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="bg-indigo-700 text-white p-4 rounded-xl mb-6 shadow-xl">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-extrabold flex items-center">
                    <i class="fas fa-ruler-combined mr-3 text-yellow-300"></i> Tailor Shop Manager
                </h1>
                <div class="flex items-center space-x-4">
                    <select id="measurementUnit" class="bg-indigo-600 border border-indigo-500 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-yellow-300">
                        <option value="imperial">Inches</option>
                        <option value="metric">Centimeters</option>
                    </select>
                    <div class="text-xs opacity-75 hidden sm:block">
                        <p>Date: <span id="currentDate" class="font-mono text-yellow-300"></span></p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Notification -->
        <div id="notification" class="notification hidden"></div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="loading-spinner mb-4"></div>
                <p class="text-lg font-semibold text-gray-700">Loading Tailoring Shop...</p>
                <p id="loadingStatus" class="text-sm text-gray-500 mt-2">Initializing application</p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <nav class="bg-white shadow-lg rounded-lg mb-6">
            <div class="flex flex-wrap">
                <button class="tab-btn flex-1 py-3 text-center text-md font-semibold border-b-4 transition duration-300 border-indigo-600 text-indigo-700" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                </button>
                <button class="tab-btn flex-1 py-3 text-center text-md font-semibold border-b-4 transition duration-300 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="clients">
                    <i class="fas fa-users mr-2"></i> Clients <span id="clientsCount" class="ml-1 bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full">0</span>
                </button>
                <button class="tab-btn flex-1 py-3 text-center text-md font-semibold border-b-4 transition duration-300 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="orders">
                    <i class="fas fa-clipboard-list mr-2"></i> Orders <span id="ordersCount" class="ml-1 bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full">0</span>
                </button>
                <button class="tab-btn flex-1 py-3 text-center text-md font-semibold border-b-4 transition duration-300 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="products">
                    <i class="fas fa-tshirt mr-2"></i> Designs <span id="productsCount" class="ml-1 bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full">0</span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main id="mainContent" class="hidden">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="bg-white p-6 rounded-2xl shadow-2xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Tailoring Shop Overview</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="summary-card bg-blue-50 border border-blue-200">
                            <div class="text-blue-600 text-sm font-medium">Total Revenue</div>
                            <div id="totalRevenue" class="text-2xl font-bold text-blue-800 mt-1">MWK 0.00</div>
                        </div>
                        <div class="summary-card bg-green-50 border border-green-200">
                            <div class="text-green-600 text-sm font-medium">Pending Orders</div>
                            <div id="pendingOrders" class="text-2xl font-bold text-green-800 mt-1">0</div>
                        </div>
                        <div class="summary-card bg-purple-50 border border-purple-200">
                            <div class="text-purple-600 text-sm font-medium">Total Clients</div>
                            <div id="totalClients" class="text-2xl font-bold text-purple-800 mt-1">0</div>
                        </div>
                        <div class="summary-card bg-orange-50 border border-orange-200">
                            <div class="text-orange-600 text-sm font-medium">Total Designs</div>
                            <div id="totalDesigns" class="text-2xl font-bold text-orange-800 mt-1">0</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <button class="bg-blue-600 text-white p-4 rounded-xl shadow-lg hover:bg-blue-700 transition flex items-center justify-center" onclick="openOrderModal()">
                            <i class="fas fa-plus-circle mr-2"></i> New Order
                        </button>
                        <button class="bg-green-600 text-white p-4 rounded-xl shadow-lg hover:bg-green-700 transition flex items-center justify-center" onclick="openClientModal()">
                            <i class="fas fa-user-plus mr-2"></i> Add Client
                        </button>
                        <button class="bg-purple-600 text-white p-4 rounded-xl shadow-lg hover:bg-purple-700 transition flex items-center justify-center" onclick="openProductModal()">
                            <i class="fas fa-tshirt mr-2"></i> Add Design
                        </button>
                    </div>

                    <!-- Recent Orders -->
                    <div class="bg-white p-6 rounded-xl border border-gray-300 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">Recent Orders</h3>
                        <div id="recentOrders" class="space-y-3">
                            <div class="text-gray-500 italic text-center py-4">No recent orders</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clients Tab -->
            <div id="clients" class="tab-content">
                <div class="bg-white p-6 rounded-2xl shadow-2xl">
                    <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Client Management</h2>
                        <button onclick="openClientModal()" class="flex items-center justify-center py-2 px-4 border border-transparent text-sm font-bold rounded-lg shadow-lg text-white bg-green-600 hover:bg-green-700 transition">
                            <i class="fas fa-plus mr-2"></i> Add Client
                        </button>
                    </div>

                    <!-- Clients List -->
                    <div id="clientsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="text-gray-500 italic text-center py-8 col-span-3">No clients found</div>
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="orders" class="tab-content">
                <div class="bg-white p-6 rounded-2xl shadow-2xl">
                    <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Order Management</h2>
                        <button onclick="openOrderModal()" class="flex items-center justify-center py-2 px-4 border border-transparent text-sm font-bold rounded-lg shadow-lg text-white bg-green-600 hover:bg-green-700 transition">
                            <i class="fas fa-plus mr-2"></i> New Order
                        </button>
                    </div>

                    <!-- Orders List -->
                    <div id="ordersList" class="space-y-4">
                        <div class="text-gray-500 italic text-center py-8">No orders found</div>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products" class="tab-content">
                <div class="bg-white p-6 rounded-2xl shadow-2xl">
                    <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Design Catalog</h2>
                        <button onclick="openProductModal()" class="flex items-center justify-center py-2 px-4 border border-transparent text-sm font-bold rounded-lg shadow-lg text-white bg-green-600 hover:bg-green-700 transition">
                            <i class="fas fa-plus mr-2"></i> Add Design
                        </button>
                    </div>

                    <!-- Products Grid -->
                    <div id="productsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="text-gray-500 italic text-center py-8 col-span-3">No designs found</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-12">
            <div class="bg-red-50 border border-red-200 rounded-xl p-8 max-w-2xl mx-auto">
                <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                <h2 class="text-2xl font-bold text-red-800 mb-2">Failed to Load Application</h2>
                <p class="text-red-600 mb-4" id="errorMessage">Unable to initialize the tailoring shop application.</p>
                <button onclick="location.reload()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition">
                    <i class="fas fa-redo mr-2"></i> Reload Application
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content w-full max-w-md">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-indigo-50 rounded-t-xl">
                <h2 class="text-2xl font-bold text-indigo-800 flex items-center">
                    <i class="fas fa-user mr-3"></i> <span id="clientModalTitle">Add New Client</span>
                </h2>
                <button onclick="closeClientModal()" class="text-gray-500 hover:text-red-500 transition p-2 rounded-full hover:bg-red-50">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="clientForm" class="space-y-4">
                    <input type="hidden" id="clientId">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Full Name *</label>
                        <input type="text" id="clientName" class="input-style" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Phone Number *</label>
                        <input type="tel" id="clientPhone" class="input-style" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Location/Address</label>
                        <input type="text" id="clientLocation" class="input-style">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="clientNotes" class="input-style" rows="2"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                        <i class="fas fa-save mr-2"></i> Save Client
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content w-full max-w-2xl">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-indigo-50 rounded-t-xl">
                <h2 class="text-2xl font-bold text-indigo-800 flex items-center">
                    <i class="fas fa-plus mr-3"></i> <span id="orderModalTitle">New Order</span>
                </h2>
                <button onclick="closeOrderModal()" class="text-gray-500 hover:text-red-500 transition p-2 rounded-full hover:bg-red-50">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="orderForm" class="space-y-4">
                    <input type="hidden" id="orderId">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Select Client *</label>
                        <select id="orderClientId" class="input-style" required>
                            <option value="">-- Choose a Client --</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-medium text-gray-700">Garment Type *</label>
                            <select id="garmentType" class="input-style" required>
                                <option value="Shirt">Shirt</option>
                                <option value="Trousers">Trousers</option>
                                <option value="Jacket">Jacket</option>
                                <option value="Dress">Dress</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">Price (MWK) *</label>
                            <input type="number" id="orderPrice" class="input-style" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Order Notes</label>
                        <textarea id="orderNotes" class="input-style" rows="3" placeholder="Additional notes..."></textarea>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                        <i class="fas fa-save mr-2"></i> Save Order
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content w-full max-w-md">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-indigo-50 rounded-t-xl">
                <h2 class="text-2xl font-bold text-indigo-800 flex items-center">
                    <i class="fas fa-tshirt mr-3"></i> <span id="productModalTitle">Add New Design</span>
                </h2>
                <button onclick="closeProductModal()" class="text-gray-500 hover:text-red-500 transition p-2 rounded-full hover:bg-red-50">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="productForm" class="space-y-4">
                    <input type="hidden" id="productId">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Design Name *</label>
                        <input type="text" id="productName" class="input-style" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Category *</label>
                        <select id="productCategory" class="input-style" required>
                            <option value="Shirt">Shirt</option>
                            <option value="Trousers">Trousers</option>
                            <option value="Jacket">Jacket</option>
                            <option value="Dress">Dress</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Price (MWK) *</label>
                        <input type="number" id="productPrice" class="input-style" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Description</label>
                        <textarea id="productDescription" class="input-style" rows="3"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                        <i class="fas fa-save mr-2"></i> Save Design
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Simple data storage (fallback when Firebase fails)
        let clients = JSON.parse(localStorage.getItem('tailoring_clients')) || [];
        let orders = JSON.parse(localStorage.getItem('tailoring_orders')) || [];
        let products = JSON.parse(localStorage.getItem('tailoring_products')) || [];

        // Utility functions
        const formatCurrency = (amount) => {
            return `MWK ${parseFloat(amount || 0).toFixed(2)}`;
        };

        const showNotification = (message, type = 'success') => {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 5000);
        };

        const updateLoadingStatus = (message) => {
            const statusElement = document.getElementById('loadingStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
        };

        // Data Management
        class TailoringManager {
            static saveToLocalStorage() {
                localStorage.setItem('tailoring_clients', JSON.stringify(clients));
                localStorage.setItem('tailoring_orders', JSON.stringify(orders));
                localStorage.setItem('tailoring_products', JSON.stringify(products));
            }

            static loadClients() {
                updateLoadingStatus('Loading clients...');
                const clientsList = document.getElementById('clientsList');
                
                if (clients.length === 0) {
                    clientsList.innerHTML = '<div class="text-gray-500 italic text-center py-8 col-span-3">No clients found</div>';
                    return;
                }

                clientsList.innerHTML = clients.map(client => `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-800">${client.name}</h3>
                                <p class="text-gray-600">${client.phone || 'No phone'}</p>
                                <p class="text-sm text-gray-500">${client.location || 'No location'}</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <button onclick="editClient('${client.id}')" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                <i class="fas fa-edit mr-1"></i> Edit
                            </button>
                            <button onclick="useClientForOrder('${client.id}')" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-sm font-medium hover:bg-indigo-700 transition">
                                <i class="fas fa-cart-plus mr-1"></i> New Order
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            static loadOrders() {
                updateLoadingStatus('Loading orders...');
                const ordersList = document.getElementById('ordersList');
                
                if (orders.length === 0) {
                    ordersList.innerHTML = '<div class="text-gray-500 italic text-center py-8">No orders found</div>';
                    return;
                }

                ordersList.innerHTML = orders.map(order => {
                    const client = clients.find(c => c.id === order.clientId);
                    const statusClass = order.status || 'pending';
                    const statusText = order.status ? order.status.replace('-', ' ') : 'pending';

                    return `
                        <div class="order-card ${statusClass} bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-gray-800">${order.garmentType} - ${client?.name || 'Unknown Client'}</h3>
                                    <p class="text-gray-600">Client: ${client?.phone || 'N/A'}</p>
                                    <p class="text-sm text-gray-500">${order.orderDate || ''}</p>
                                </div>
                                <div class="text-right">
                                    <span class="status-badge status-${statusClass} capitalize">${statusText}</span>
                                    <div class="text-lg font-bold text-green-600 mt-1">${formatCurrency(order.price)}</div>
                                </div>
                            </div>
                            ${order.notes ? `<p class="text-sm text-gray-500">${order.notes}</p>` : ''}
                        </div>
                    `;
                }).join('');
            }

            static loadProducts() {
                updateLoadingStatus('Loading designs...');
                const productsList = document.getElementById('productsList');
                
                if (products.length === 0) {
                    productsList.innerHTML = '<div class="text-gray-500 italic text-center py-8 col-span-3">No designs found</div>';
                    return;
                }

                productsList.innerHTML = products.map(product => `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-bold text-gray-800">${product.name}</h3>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-green-600">${formatCurrency(product.price)}</div>
                                <span class="text-xs text-gray-500">${product.category}</span>
                            </div>
                        </div>
                        ${product.description ? `<p class="text-sm text-gray-600 mb-3">${product.description}</p>` : ''}
                        <div class="text-xs text-gray-400">
                            Added: ${product.createdAt ? new Date(product.createdAt).toLocaleDateString() : 'N/A'}
                        </div>
                    </div>
                `).join('');
            }

            static updateDashboard() {
                updateLoadingStatus('Updating dashboard...');
                
                const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.price) || 0), 0);
                const pendingOrders = orders.filter(o => o.status === 'pending').length;
                
                document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
                document.getElementById('pendingOrders').textContent = pendingOrders;
                document.getElementById('totalClients').textContent = clients.length;
                document.getElementById('totalDesigns').textContent = products.length;

                // Update recent orders
                const recentOrders = document.getElementById('recentOrders');
                const recentOrdersList = orders.slice(0, 5);
                
                if (recentOrdersList.length === 0) {
                    recentOrders.innerHTML = '<div class="text-gray-500 italic text-center py-4">No recent orders</div>';
                    return;
                }

                recentOrders.innerHTML = recentOrdersList.map(order => {
                    const client = clients.find(c => c.id === order.clientId);
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">${order.garmentType} for ${client?.name || 'Unknown Client'}</p>
                                    <p class="text-xs text-gray-500">${formatCurrency(order.price)}</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${order.orderDate || 'Recently'}</span>
                        </div>
                    `;
                }).join('');
            }

            static updateTabCounts() {
                document.getElementById('clientsCount').textContent = clients.length;
                document.getElementById('ordersCount').textContent = orders.length;
                document.getElementById('productsCount').textContent = products.length;
            }

            static async saveClient(clientData, clientId = null) {
                try {
                    if (clientId) {
                        const index = clients.findIndex(c => c.id === clientId);
                        if (index !== -1) {
                            clients[index] = { ...clients[index], ...clientData, updatedAt: new Date().toISOString() };
                        }
                    } else {
                        const newClient = {
                            id: 'client_' + Date.now(),
                            ...clientData,
                            createdAt: new Date().toISOString(),
                            totalOrders: 0,
                            totalSpent: 0
                        };
                        clients.push(newClient);
                    }
                    
                    this.saveToLocalStorage();
                    this.loadClients();
                    this.updateDashboard();
                    this.updateTabCounts();
                    closeClientModal();
                    showNotification('Client saved successfully!', 'success');
                } catch (error) {
                    console.error("Error saving client:", error);
                    showNotification('Failed to save client', 'error');
                }
            }

            static async saveOrder(orderData, orderId = null) {
                try {
                    const client = clients.find(c => c.id === orderData.clientId);
                    
                    if (orderId) {
                        const index = orders.findIndex(o => o.id === orderId);
                        if (index !== -1) {
                            orders[index] = { 
                                ...orders[index], 
                                ...orderData,
                                clientName: client?.name || 'Unknown Client',
                                updatedAt: new Date().toISOString()
                            };
                        }
                    } else {
                        const newOrder = {
                            id: 'order_' + Date.now(),
                            ...orderData,
                            clientName: client?.name || 'Unknown Client',
                            createdAt: new Date().toISOString(),
                            orderDate: new Date().toISOString().split('T')[0],
                            status: 'pending'
                        };
                        orders.push(newOrder);
                    }
                    
                    this.saveToLocalStorage();
                    this.loadOrders();
                    this.updateDashboard();
                    this.updateTabCounts();
                    closeOrderModal();
                    showNotification('Order saved successfully!', 'success');
                } catch (error) {
                    console.error("Error saving order:", error);
                    showNotification('Failed to save order', 'error');
                }
            }

            static async saveProduct(productData, productId = null) {
                try {
                    if (productId) {
                        const index = products.findIndex(p => p.id === productId);
                        if (index !== -1) {
                            products[index] = { ...products[index], ...productData, updatedAt: new Date().toISOString() };
                        }
                    } else {
                        const newProduct = {
                            id: 'product_' + Date.now(),
                            ...productData,
                            createdAt: new Date().toISOString()
                        };
                        products.push(newProduct);
                    }
                    
                    this.saveToLocalStorage();
                    this.loadProducts();
                    this.updateDashboard();
                    this.updateTabCounts();
                    closeProductModal();
                    showNotification('Design saved successfully!', 'success');
                } catch (error) {
                    console.error("Error saving product:", error);
                    showNotification('Failed to save design', 'error');
                }
            }

            static populateClientDropdown() {
                const dropdown = document.getElementById('orderClientId');
                dropdown.innerHTML = '<option value="">-- Choose a Client --</option>';
                
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name} (${client.phone || 'No phone'})`;
                    dropdown.appendChild(option);
                });
            }

            static async loadAllData() {
                try {
                    updateLoadingStatus('Loading application data...');
                    
                    this.loadClients();
                    this.loadOrders();
                    this.loadProducts();
                    this.updateDashboard();
                    this.updateTabCounts();
                    this.populateClientDropdown();
                    
                    // Hide loading screen and show main content
                    setTimeout(() => {
                        document.getElementById('loadingScreen').classList.add('hidden');
                        document.getElementById('mainContent').classList.remove('hidden');
                        showNotification('Tailoring shop ready!', 'success');
                    }, 1000);
                    
                } catch (error) {
                    console.error("Error loading data:", error);
                    this.showErrorState('Failed to load application data: ' + error.message);
                }
            }

            static showErrorState(message) {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = message;
            }
        }

        // Initialize the application
        const initTailoringApp = async () => {
            try {
                updateLoadingStatus('Initializing application...');
                
                // Set current date
                document.getElementById('currentDate').textContent = new Date().toISOString().split('T')[0];
                
                // Initialize event listeners
                initializeEventListeners();
                
                // Load all data
                await TailoringManager.loadAllData();
                
            } catch (error) {
                console.error("Failed to initialize tailoring app:", error);
                TailoringManager.showErrorState(error.message);
            }
        };

        // Event Listeners
        function initializeEventListeners() {
            // Client form
            document.getElementById('clientForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const clientId = document.getElementById('clientId').value;
                const formData = {
                    name: document.getElementById('clientName').value.trim(),
                    phone: document.getElementById('clientPhone').value.trim(),
                    location: document.getElementById('clientLocation').value.trim(),
                    notes: document.getElementById('clientNotes').value.trim()
                };

                if (!formData.name || !formData.phone) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                await TailoringManager.saveClient(formData, clientId || null);
            });

            // Order form
            document.getElementById('orderForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const orderId = document.getElementById('orderId').value;
                const formData = {
                    clientId: document.getElementById('orderClientId').value,
                    garmentType: document.getElementById('garmentType').value,
                    price: parseFloat(document.getElementById('orderPrice').value) || 0,
                    notes: document.getElementById('orderNotes').value.trim()
                };

                if (!formData.clientId || !formData.garmentType || formData.price <= 0) {
                    showNotification('Please fill in all required fields with valid data', 'error');
                    return;
                }

                await TailoringManager.saveOrder(formData, orderId || null);
            });

            // Product form
            document.getElementById('productForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const productId = document.getElementById('productId').value;
                const formData = {
                    name: document.getElementById('productName').value.trim(),
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value) || 0,
                    description: document.getElementById('productDescription').value.trim()
                };

                if (!formData.name || !formData.category || formData.price <= 0) {
                    showNotification('Please fill in all required fields with valid data', 'error');
                    return;
                }

                await TailoringManager.saveProduct(formData, productId || null);
            });
        }

        // Modal management
        function openClientModal(clientId = null) {
            document.getElementById('clientModalTitle').textContent = clientId ? 'Edit Client' : 'Add New Client';
            document.getElementById('clientId').value = clientId || '';
            
            if (clientId) {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    document.getElementById('clientName').value = client.name || '';
                    document.getElementById('clientPhone').value = client.phone || '';
                    document.getElementById('clientLocation').value = client.location || '';
                    document.getElementById('clientNotes').value = client.notes || '';
                }
            } else {
                document.getElementById('clientForm').reset();
            }
            
            document.getElementById('clientModal').classList.add('active');
        }

        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('active');
        }

        function openOrderModal(clientId = null) {
            document.getElementById('orderModalTitle').textContent = 'New Order';
            document.getElementById('orderId').value = '';
            
            document.getElementById('orderForm').reset();
            
            if (clientId) {
                document.getElementById('orderClientId').value = clientId;
            }
            
            document.getElementById('orderModal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        function openProductModal(productId = null) {
            document.getElementById('productModalTitle').textContent = productId ? 'Edit Design' : 'Add New Design';
            document.getElementById('productId').value = productId || '';
            
            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('productName').value = product.name || '';
                    document.getElementById('productCategory').value = product.category || '';
                    document.getElementById('productPrice').value = product.price || '';
                    document.getElementById('productDescription').value = product.description || '';
                }
            } else {
                document.getElementById('productForm').reset();
            }
            
            document.getElementById('productModal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        // Edit functions
        function editClient(clientId) {
            openClientModal(clientId);
        }

        function useClientForOrder(clientId) {
            switchTab('orders');
            openOrderModal(clientId);
        }

        // Tab management
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-indigo-600', 'text-indigo-700');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-indigo-600', 'text-indigo-700');
        }

        // Initialize tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.getAttribute('data-tab'));
            });
        });

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Make TailoringManager available globally
        window.TailoringManager = TailoringManager;
        window.openOrderModal = openOrderModal;
        window.openClientModal = openClientModal;
        window.openProductModal = openProductModal;
        window.editClient = editClient;
        window.useClientForOrder = useClientForOrder;

        // Initialize when page loads
        window.onload = initTailoringApp;
    </script>
</body>
</html>
