import React, { useState, useEffect } from 'react';

// Helper for unique IDs
const generateId = () => `_${Math.random().toString(36).substr(2, 9)}`;

// --- Mock Data ---
const initialCustomers = [
    { id: 'c1', name: 'John Doe', phone: '555-1234', email: 'john.doe@example.com', location: 'Blantyre' },
    { id: 'c2', name: 'Jane Smith', phone: '555-5678', email: 'jane.smith@example.com', location: 'Limbe' },
];

const initialGarments = [
    { id: 'g1', name: 'Men\'s Shirt', price: 45000, measurements: ['Neck', 'Chest', 'Sleeve', 'Waist', 'Length'] },
    { id: 'g2', name: 'Women\'s Dress', price: 75000, measurements: ['Bust', 'Waist', 'Hips', 'Length'] },
];

const initialOrders = [
    { id: 'o1', customerId: 'c1', garmentId: 'g1', status: 'In Progress', creationDate: '2023-10-26', deliveryDate: '2023-11-10', trialDate: '2023-11-05T14:00', measurements: { Neck: '16', Chest: '42', Sleeve: '25' }, price: 45000, paid: 20000, fabricPicture: 'https://placehold.co/100x100/EFEFEF/333?text=Fabric', styleImage: 'https://placehold.co/100x100/EFEFEF/333?text=Style' },
    { id: 'o2', customerId: 'c2', garmentId: 'g2', status: 'Completed', creationDate: '2023-10-20', deliveryDate: '2023-11-01', trialDate: '2023-10-28T11:00', measurements: { Bust: '36', Waist: '28' }, price: 75000, paid: 75000, fabricPicture: 'https://placehold.co/100x100/EFEFEF/333?text=Fabric', styleImage: 'https://placehold.co/100x100/EFEFEF/333?text=Style' },
];

const initialFabrics = [
    { id: 'f1', name: 'Cotton', price: 8000 },
    { id: 'f2', name: 'Silk', price: 15000 },
];

const initialEquipment = [
    { id: 'e1', name: 'Sewing Machine', quantity: 3 },
    { id: 'e2', name: 'Scissors', quantity: 10 },
];

const initialWorkers = [
    { id: 'w1', name: 'Alice', role: 'Lead Tailor' },
    { id: 'w2', name: 'Bob', role: 'Apprentice' },
];

const initialLoans = [
    { id: 'l1', lender: 'Bank', amount: 5000000, paid: 1000000, date: '2023-01-15' },
];

const initialExpenses = [
    { id: 'ex1', category: 'Rent', amount: 250000, date: '2023-10-01' },
    { id: 'ex2', category: 'Utilities', amount: 75000, date: '2023-10-05' },
];

// --- Main App Component ---
export default function App() {
    const [activeView, setActiveView] = useState('dashboard');
    const [unit, setUnit] = useState('inches');

    // --- State Management for all features ---
    const [customers, setCustomers] = useState(initialCustomers);
    const [orders, setOrders] = useState(initialOrders);
    const [garments, setGarments] = useState(initialGarments);
    const [fabrics, setFabrics] = useState(initialFabrics);
    const [equipment, setEquipment] = useState(initialEquipment);
    const [workers, setWorkers] = useState(initialWorkers);
    const [loans, setLoans] = useState(initialLoans);
    const [expenses, setExpenses] = useState(initialExpenses);

    const renderView = () => {
        switch (activeView) {
            case 'dashboard': return <DashboardView orders={orders} expenses={expenses} />;
            case 'customers': return <CustomersView customers={customers} setCustomers={setCustomers} />;
            case 'orders': return <OrdersView orders={orders} setOrders={setOrders} customers={customers} garments={garments} unit={unit} />;
            case 'catalogue': return <GarmentCatalogueView garments={garments} setGarments={setGarments} />;
            // FIX: Expense CRUD logic is now within FinancesView
            case 'finances': return <FinancesView orders={orders} expenses={expenses} setExpenses={setExpenses} />;
            
            // FIX: Changed prop names to generic 'items' and 'setItems' to match createCrudView destructuring
            case 'fabrics': return <FabricsView items={fabrics} setItems={setFabrics} />;
            case 'equipment': return <EquipmentView items={equipment} setItems={setEquipment} />;
            case 'workers': return <WorkersView items={workers} setItems={setWorkers} />;
            case 'loans': return <LoansView items={loans} setItems={setLoans} />;
            default: return <DashboardView orders={orders} expenses={expenses} />;
        }
    };

    return (
        <div className="bg-gray-100 min-h-screen font-sans text-gray-800 pb-24">
            <div className="container mx-auto p-4 max-w-lg">
                <Header unit={unit} setUnit={setUnit} />
                <main className="mt-4">{renderView()}</main>
                <NavBar activeView={activeView} setActiveView={setActiveView} />
            </div>
        </div>
    );
}

// --- Generic Components ---
const Header = ({ unit, setUnit }) => (
    <header className="bg-white p-4 rounded-lg shadow-md flex justify-between items-center">
        <h1 className="text-2xl font-bold text-purple-700">TailorFlow</h1>
        <div className="flex items-center space-x-2">
            <span className="text-sm font-medium">Units:</span>
            <select value={unit} onChange={(e) => setUnit(e.target.value)} className="p-1 border rounded-md">
                <option value="inches">Inches</option>
                <option value="cm">cm</option>
            </select>
        </div>
    </header>
);

const NavBar = ({ activeView, setActiveView }) => {
    const navItems = [
        { id: 'dashboard', label: 'Dashboard', icon: '🏠' },
        { id: 'customers', label: 'Customers', icon: '👥' },
        { id: 'orders', label: 'Orders', icon: '✂️' },
        { id: 'catalogue', label: 'Catalogue', icon: '👚' },
        { id: 'finances', label: 'Finances', icon: '💰' },
        { id: 'fabrics', label: 'Fabrics', icon: '🧵' },
        { id: 'equipment', label: 'Equipment', icon: '🛠️' },
        { id: 'workers', label: 'Workers', icon: '👷' },
        { id: 'loans', label: 'Loans', icon: '🏦' },
    ];
    return (
        <nav className="fixed bottom-0 left-0 right-0 bg-white shadow-lg overflow-x-auto"><div className="flex justify-around max-w-lg mx-auto">{navItems.map(item => (<button key={item.id} onClick={() => setActiveView(item.id)} className={`flex flex-col items-center justify-center p-2 w-full ${activeView === item.id ? 'text-purple-700' : 'text-gray-500'}`}><span className="text-2xl">{item.icon}</span><span className="text-xs">{item.label}</span></button>))}</div></nav>
    );
};
const Card = ({ children, className }) => (<div className={`bg-white p-4 rounded-lg shadow-md mb-4 ${className}`}>{children}</div>);
const Button = ({ onClick, children, className = 'bg-purple-600 hover:bg-purple-700 text-white', type = 'button' }) => (<button type={type} onClick={onClick} className={`w-full py-2 px-4 rounded-lg font-semibold transition ${className}`}>{children}</button>);
const ViewHeader = ({ title, onAdd }) => (<div className="flex justify-between items-center mb-4"><h2 className="text-xl font-semibold">{title}</h2><Button onClick={onAdd} className="w-auto px-4 py-1 text-sm bg-purple-500 hover:bg-purple-600">+</Button></div>);
const CrudListItem = ({ onEdit, onDelete, children }) => (<div className="flex justify-between items-center"><div>{children}</div><div><button onClick={onEdit} className="text-blue-500 mr-2">Edit</button><button onClick={onDelete} className="text-red-500">Delete</button></div></div>);
const FormButtons = ({ onCancel }) => (<div className="flex space-x-2 mt-4"><Button onClick={onCancel} className="bg-gray-300 hover:bg-gray-400 text-gray-800">Cancel</Button><Button type="submit">Save</Button></div>);

// --- Dashboard View ---
const DashboardView = ({ orders, expenses }) => {
    const totalIncome = orders.reduce((sum, order) => sum + order.paid, 0);
    const totalExpected = orders.reduce((sum, order) => sum + order.price, 0);
    const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
    return (
        <div>
            <h2 className="text-xl font-semibold mb-4">Dashboard</h2>
            <div className="grid grid-cols-2 gap-4">
                <Card><h3 className="font-bold text-lg text-green-600">MWK {totalIncome.toLocaleString()}</h3><p className="text-sm text-gray-500">Total Income</p></Card>
                <Card><h3 className="font-bold text-lg text-blue-600">MWK {totalExpected.toLocaleString()}</h3><p className="text-sm text-gray-500">Expected Income</p></Card>
                <Card><h3 className="font-bold text-lg text-red-600">MWK {totalExpenses.toLocaleString()}</h3><p className="text-sm text-gray-500">Total Expenses</p></Card>
                <Card><h3 className="font-bold text-lg text-purple-600">MWK {(totalIncome - totalExpenses).toLocaleString()}</h3><p className="text-sm text-gray-500">Net Profit</p></Card>
            </div>
             <Card className="mt-4">
                <h3 className="font-semibold mb-2">Upcoming Deadlines</h3>
                <ul>{orders.filter(o => o.status !== 'Delivered' && o.status !== 'Completed').slice(0, 3).map(order => (<li key={order.id} className="text-sm border-b py-1">Order #{order.id.slice(-4)} due on {order.deliveryDate}</li>))}</ul>
            </Card>
        </div>
    );
};

// --- Customer Management ---
const CustomersView = ({ customers, setCustomers }) => {
    const [editingCustomer, setEditingCustomer] = useState(null);
    const handleSave = (customer) => {
        if (customer.id) { setCustomers(customers.map(c => c.id === customer.id ? customer : c)); } 
        else { setCustomers([...customers, { ...customer, id: generateId() }]); }
        setEditingCustomer(null);
    };
    const handleDelete = (id) => setCustomers(customers.filter(c => c.id !== id));

    if (editingCustomer) return <CustomerForm customer={editingCustomer} onSave={handleSave} onCancel={() => setEditingCustomer(null)} />;
    return (
        <div>
            <ViewHeader title="Customers" onAdd={() => setEditingCustomer({ name: '', phone: '', email: '', location: '' })} />
            {customers.map(customer => (
                <Card key={customer.id}>
                    <CrudListItem onEdit={() => setEditingCustomer(customer)} onDelete={() => handleDelete(customer.id)}>
                        <p className="font-semibold">{customer.name}</p>
                        <p className="text-sm text-gray-500">{customer.phone} | {customer.location}</p>
                    </CrudListItem>
                </Card>
            ))}
        </div>
    );
};
const CustomerForm = ({ customer, onSave, onCancel }) => {
    const [formData, setFormData] = useState(customer);
    const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
    const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };
    return (
        <Card>
            <h3 className="text-lg font-semibold mb-4">{customer.id ? 'Edit Customer' : 'New Customer'}</h3>
            <form onSubmit={handleSubmit} className="space-y-4">
                <input type="text" name="name" value={formData.name} onChange={handleChange} placeholder="Name" className="w-full p-2 border rounded" required />
                <input type="tel" name="phone" value={formData.phone} onChange={handleChange} placeholder="Phone" className="w-full p-2 border rounded" required />
                <input type="email" name="email" value={formData.email} onChange={handleChange} placeholder="Email" className="w-full p-2 border rounded" />
                <input type="text" name="location" value={formData.location} onChange={handleChange} placeholder="Location" className="w-full p-2 border rounded" />
                <FormButtons onCancel={onCancel} />
            </form>
        </Card>
    );
};

// --- Order Management ---
const OrdersView = ({ orders, setOrders, customers, garments, unit }) => {
    const [editingOrder, setEditingOrder] = useState(null);
    const getCustomerName = (id) => customers.find(c => c.id === id)?.name || 'Unknown';
    const handleSave = (order) => {
        if (order.id) { setOrders(orders.map(o => o.id === order.id ? order : o)); } 
        else { setOrders([...orders, { ...order, id: generateId(), creationDate: new Date().toISOString().split('T')[0] }]); }
        setEditingOrder(null);
    };
    const handleDelete = (id) => setOrders(orders.filter(o => o.id !== id));

    if (editingOrder) return <OrderForm order={editingOrder} onSave={handleSave} onCancel={() => setEditingOrder(null)} customers={customers} garments={garments} unit={unit} />;
    return (
        <div>
            <ViewHeader title="Orders" onAdd={() => setEditingOrder({ customerId: '', garmentId: '', status: 'Pending', measurements: {}, price: 0, paid: 0 })} />
            {orders.map(order => (
                 <Card key={order.id}>
                    <div className="flex justify-between items-start">
                        <div><p className="font-bold">Order #{order.id.slice(-4)}</p><p className="text-sm">{getCustomerName(order.customerId)}</p></div>
                        <span className={`px-2 py-1 text-xs font-semibold rounded-full ${order.status === 'Completed' || order.status === 'Delivered' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}`}>{order.status}</span>
                    </div>
                    <div className="text-sm mt-2"><p>Due: {order.deliveryDate}</p><p className="font-semibold">MWK {order.paid.toLocaleString()} / MWK {order.price.toLocaleString()}</p></div>
                    <div className="mt-2 text-right"><button onClick={() => setEditingOrder(order)} className="text-blue-500">View/Edit</button><button onClick={() => handleDelete(order.id)} className="text-red-500 ml-2">Delete</button></div>
                </Card>
            ))}
        </div>
    );
};
const OrderForm = ({ order, onSave, onCancel, customers, garments, unit }) => {
    const [formData, setFormData] = useState(order);
    const selectedGarment = garments.find(g => g.id === formData.garmentId);
    const handleChange = (e) => {
        const { name, value, type } = e.target;
        setFormData(prev => ({ ...prev, [name]: type === 'number' ? parseFloat(value) : value }));
        if (name === 'garmentId') {
            const garment = garments.find(g => g.id === value);
            if(garment) setFormData(prev => ({ ...prev, price: garment.price, measurements: {} }));
        }
    };
    const handleMeasurementChange = (name, value) => setFormData(prev => ({...prev, measurements: { ...prev.measurements, [name]: value }}));
    const handleSubmit = e => { e.preventDefault(); onSave(formData); };
    return (
        <Card>
            <h3 className="font-semibold text-lg mb-4">{order.id ? 'Edit Order' : 'New Order'}</h3>
            <form onSubmit={handleSubmit} className="space-y-4 text-sm">
                <select name="customerId" value={formData.customerId} onChange={handleChange} className="w-full p-2 border rounded" required><option value="">Select Customer</option>{customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select>
                <select name="garmentId" value={formData.garmentId} onChange={handleChange} className="w-full p-2 border rounded" required><option value="">Select Garment</option>{garments.map(g => <option key={g.id} value={g.id}>{g.name}</option>)}</select>
                {selectedGarment && (<div className="p-2 border rounded"><h4 className="font-semibold mb-2">Measurements ({unit})</h4>{selectedGarment.measurements.map(m => (<div key={m} className="flex items-center justify-between mb-1"><label>{m}:</label><input type="number" step="0.1" value={formData.measurements[m] || ''} onChange={(e) => handleMeasurementChange(m, e.target.value)} className="w-1/2 p-1 border rounded" /></div>))}</div>)}
                <div className="grid grid-cols-2 gap-4"><div><label>Fabric Picture</label><input type="file" className="w-full text-xs" /></div><div><label>Style Image</label><input type="file" className="w-full text-xs" /></div></div>
                <div className="grid grid-cols-2 gap-4"><div><label>Trial Date</label><input type="datetime-local" name="trialDate" value={formData.trialDate || ''} onChange={handleChange} className="w-full p-2 border rounded" /></div><div><label>Delivery Date</label><input type="date" name="deliveryDate" value={formData.deliveryDate || ''} onChange={handleChange} className="w-full p-2 border rounded" /></div></div>
                <select name="status" value={formData.status} onChange={handleChange} className="w-full p-2 border rounded"><option>Pending</option><option>In Progress</option><option>Ready for Trial</option><option>Completed</option><option>Delivered</option></select>
                <div className="grid grid-cols-2 gap-4"><div><label>Total Price (MWK)</label><input type="number" step="1" name="price" value={formData.price} onChange={handleChange} className="w-full p-2 border rounded" /></div><div><label>Amount Paid (MWK)</label><input type="number" step="1" name="paid" value={formData.paid} onChange={handleChange} className="w-full p-2 border rounded" /></div></div>
                <FormButtons onCancel={onCancel} />
            </form>
        </Card>
    );
};

// --- Garment Catalogue Management ---
const GarmentCatalogueView = ({ garments, setGarments }) => {
    const [editingGarment, setEditingGarment] = useState(null);
    const handleSave = (garment) => {
        if (garment.id) { setGarments(garments.map(g => g.id === garment.id ? garment : g)); } 
        else { setGarments([...garments, { ...garment, id: generateId() }]); }
        setEditingGarment(null);
    };
    const handleDelete = (id) => setGarments(garments.filter(g => g.id !== id));

    if (editingGarment) return <GarmentForm garment={editingGarment} onSave={handleSave} onCancel={() => setEditingGarment(null)} />;
    return (
        <div>
            <ViewHeader title="Garment Catalogue" onAdd={() => setEditingGarment({ name: '', price: 0, measurements: [] })} />
            {garments.map(garment => (
                <Card key={garment.id}>
                    <CrudListItem onEdit={() => setEditingGarment(garment)} onDelete={() => handleDelete(garment.id)}>
                        <p className="font-semibold">{garment.name}</p>
                        <p className="text-sm text-purple-600 font-bold">MWK {garment.price.toLocaleString()}</p>
                        <p className="text-xs text-gray-500 mt-1">{garment.measurements.join(', ')}</p>
                    </CrudListItem>
                </Card>
            ))}
        </div>
    );
};
const GarmentForm = ({ garment, onSave, onCancel }) => {
    const [formData, setFormData] = useState({...garment, measurements: Array.isArray(garment.measurements) ? garment.measurements.join(', ') : ''});
    const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.type === 'number' ? parseFloat(e.target.value) : e.target.value }));
    const handleSubmit = (e) => {
        e.preventDefault();
        onSave({ ...formData, measurements: formData.measurements.split(',').map(m => m.trim()).filter(Boolean) });
    };
    return (
        <Card>
            <h3 className="text-lg font-semibold mb-4">{garment.id ? 'Edit Garment' : 'New Garment'}</h3>
            <form onSubmit={handleSubmit} className="space-y-4">
                <input type="text" name="name" value={formData.name} onChange={handleChange} placeholder="Garment Name" className="w-full p-2 border rounded" required />
                <div><label className="text-sm">Price (MWK)</label><input type="number" name="price" value={formData.price} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                <div><label className="text-sm">Measurements (comma separated)</label><textarea name="measurements" value={formData.measurements} onChange={handleChange} placeholder="e.g. Bust, Waist, Hips" className="w-full p-2 border rounded" /></div>
                <FormButtons onCancel={onCancel} />
            </form>
        </Card>
    );
};

// --- Expenses CRUD Components ---
const ExpenseForm = ({ item, onSave, onCancel }) => {
    const [formData, setFormData] = useState(item);
    const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.type === 'number' ? parseFloat(e.target.value) : e.target.value }));
    const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };
    return (
        <Card><h3 className="text-lg font-semibold mb-4">{item.id ? 'Edit Expense' : 'New Expense'}</h3><form onSubmit={handleSubmit} className="space-y-4">
            <input type="text" name="category" value={formData.category} onChange={handleChange} placeholder="Category (e.g., Rent, Utilities)" className="w-full p-2 border rounded" required />
            <div><label className="text-sm">Amount (MWK)</label><input type="number" step="1" name="amount" value={formData.amount} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
            <div><label className="text-sm">Date</label><input type="date" name="date" value={formData.date} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
            <FormButtons onCancel={onCancel} /></form>
        </Card>
    );
};

const ExpensesView = ({ expenses, setExpenses }) => {
    const [editingExpense, setEditingExpense] = useState(null);
    const handleSave = (expense) => {
        if (expense.id) { setExpenses(expenses.map(e => e.id === expense.id ? expense : e)); } 
        else { setExpenses([...expenses, { ...expense, id: generateId() }]); }
        setEditingExpense(null);
    };
    const handleDelete = (id) => setExpenses(expenses.filter(e => e.id !== id));

    if (editingExpense) return <ExpenseForm item={editingExpense} onSave={handleSave} onCancel={() => setEditingExpense(null)} />;
    return (
        <div className="mt-4">
            <ViewHeader title="Expense Log" onAdd={() => setEditingExpense({ category: '', amount: 0, date: new Date().toISOString().split('T')[0] })} />
            {expenses.map(expense => (
                <Card key={expense.id}>
                    <CrudListItem onEdit={() => setEditingExpense(expense)} onDelete={() => handleDelete(expense.id)}>
                        <p className="font-semibold">{expense.category}</p>
                        <p className="text-sm text-red-600 font-bold">MWK {expense.amount.toLocaleString()}</p>
                        <p className="text-xs text-gray-500 mt-1">Date: {expense.date}</p>
                    </CrudListItem>
                </Card>
            ))}
        </div>
    );
};

// --- Finances View (Container) ---
const FinancesView = ({ orders, expenses, setExpenses }) => {
    const totalIncome = orders.reduce((sum, order) => sum + order.paid, 0);
    const totalBalance = orders.reduce((sum, order) => sum + (order.price - order.paid), 0);
    const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
    return (
        <div>
            <h2 className="text-xl font-semibold mb-4">Finances</h2>
            <Card>
                <h3 className="font-bold text-lg">Income Overview</h3>
                <p>Total Paid: <span className="text-green-600">MWK {totalIncome.toLocaleString()}</span></p>
                <p>Outstanding Balance: <span className="text-yellow-600">MWK {totalBalance.toLocaleString()}</span></p>
            </Card>
            <Card>
                <h3 className="font-bold text-lg">Expenses Summary</h3>
                <p>Total This Month: <span className="text-red-600">MWK {totalExpenses.toLocaleString()}</span></p>
            </Card>
            
            {/* Expense CRUD list is now embedded here */}
            <ExpensesView expenses={expenses} setExpenses={setExpenses} />

            <Card><h3 className="font-bold text-lg mb-2">Export Data</h3><p className="text-sm text-gray-600 mb-2">You can export your data as a CSV file, which opens perfectly in Excel.</p><Button onClick={() => alert("CSV export functionality would be implemented here.")}>Export All Data (CSV)</Button></Card>
        </div>
    );
};

// --- Generic CRUD Views ---
const createCrudView = (title, initialEntity, FormComponent) => ({ items, setItems }) => {
    const [editingItem, setEditingItem] = useState(null);
    const handleSave = (item) => {
        if (item.id) { setItems(items.map(i => i.id === item.id ? item : i)); } 
        else { setItems([...items, { ...item, id: generateId() }]); }
        setEditingItem(null);
    };
    const handleDelete = (id) => setItems(items.filter(i => i.id !== id));

    if (editingItem) return <FormComponent item={editingItem} onSave={handleSave} onCancel={() => setEditingItem(null)} />;
    return (
        <div>
            <ViewHeader title={title} onAdd={() => setEditingItem(initialEntity)} />
            {/* The generic view items must now be passed as 'items' prop */}
            {items.map(item => (
                <Card key={item.id}>
                    <CrudListItem onEdit={() => setEditingItem(item)} onDelete={() => handleDelete(item.id)}>
                        {/* Generic title logic */}
                        <p className="font-semibold">{item.name || item.lender}</p>
                        {/* Generic details logic (updated for clarity) */}
                        <p className="text-sm text-gray-500">
                            {item.price && `Price: MWK ${item.price.toLocaleString()}`}
                            {item.quantity && `Quantity: ${item.quantity}`}
                            {item.role && `Role: ${item.role}`}
                            {item.lender && `Paid: MWK ${item.paid.toLocaleString()} / Total: MWK ${item.amount.toLocaleString()}`}
                        </p>
                    </CrudListItem>
                </Card>
            ))}
        </div>
    );
};

// --- Fabric Management ---
const FabricForm = ({ item, onSave, onCancel }) => {
    const [formData, setFormData] = useState(item);
    const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.type === 'number' ? parseFloat(e.target.value) : e.target.value }));
    const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };
    return (
        <Card><h3 className="text-lg font-semibold mb-4">{item.id ? 'Edit Fabric' : 'New Fabric'}</h3><form onSubmit={handleSubmit} className="space-y-4">
            <input type="text" name="name" value={formData.name} onChange={handleChange} placeholder="Fabric Name" className="w-full p-2 border rounded" required />
            <div><label className="text-sm">Price per unit (MWK)</label><input type="number" name="price" value={formData.price} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
            <FormButtons onCancel={onCancel} /></form>
        </Card>
    );
};
const FabricsView = createCrudView('Fabrics', { name: '', price: 0 }, FabricForm);

// --- Equipment Management ---
const EquipmentForm = ({ item, onSave, onCancel }) => {
    const [formData, setFormData] = useState(item);
    const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.type === 'number' ? parseInt(e.target.value) : e.target.value }));
    const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };
    return (
        <Card><h3 className="text-lg font-semibold mb-4">{item.id ? 'Edit Equipment' : 'New Equipment'}</h3><form onSubmit={handleSubmit} className="space-y-4">
            <input type="text" name="name" value={formData.name} onChange={handleChange} placeholder="Equipment Name" className="w-full p-2 border rounded" required />
            <div><label className="text-sm">Quantity</label><input type="number" name="quantity" value={formData.quantity} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
            <FormButtons onCancel={onCancel} /></form>
        </Card>
    );
};
const EquipmentView = createCrudView('Equipment', { name: '', quantity: 1 }, EquipmentForm);

// --- Worker Management ---
const WorkerForm = ({ item, onSave, onCancel }) => {
    const [formData, setFormData] = useState(item);
    const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
    const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };
    return (
        <Card><h3 className="text-lg font-semibold mb-4">{item.id ? 'Edit Worker' : 'New Worker'}</h3><form onSubmit={handleSubmit} className="space-y-4">
            <input type="text" name="name" value={formData.name} onChange={handleChange} placeholder="Worker Name" className="w-full p-2 border rounded" required />
            <input type="text" name="role" value={formData.role} onChange={handleChange} placeholder="Role" className="w-full p-2 border rounded" required />
            <FormButtons onCancel={onCancel} /></form>
        </Card>
    );
};
const WorkersView = createCrudView('Workers', { name: '', role: '' }, WorkerForm);

// --- Loan Management ---
const LoanForm = ({ item, onSave, onCancel }) => {
    const [formData, setFormData] = useState(item);
    const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.type === 'number' ? parseFloat(e.target.value) : e.target.value }));
    const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };
    return (
        <Card><h3 className="text-lg font-semibold mb-4">{item.id ? 'Edit Loan' : 'New Loan'}</h3><form onSubmit={handleSubmit} className="space-y-4">
            <input type="text" name="lender" value={formData.lender} onChange={handleChange} placeholder="Lender Name" className="w-full p-2 border rounded" required />
            <div className="grid grid-cols-2 gap-4">
                <div><label className="text-sm">Amount (MWK)</label><input type="number" step="1" name="amount" value={formData.amount} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                <div><label className="text-sm">Paid (MWK)</label><input type="number" step="1" name="paid" value={formData.paid} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
            </div>
            <div><label className="text-sm">Date</label><input type="date" name="date" value={formData.date} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
            <FormButtons onCancel={onCancel} /></form>
        </Card>
    );
};
const LoansView = createCrudView('Loans', { lender: '', amount: 0, paid: 0, date: new Date().toISOString().split('T')[0] }, LoanForm);
