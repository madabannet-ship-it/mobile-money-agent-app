<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Balance Reconciliation</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .input-style {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150;
        }
    </style>
</head>
<body>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level to Debug
        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let userId = null;
        let todayDocumentId = null;
        let isDatabaseReady = false; // New flag to track database availability

        // --- Mock/Fallback Firebase Configuration for standalone use ---
        // This is only used to satisfy initializeApp() when running outside the Canvas.
        const mockFirebaseConfig = {
            apiKey: "MOCK_API_KEY", 
            projectId: "MOCK_PROJECT_ID",
        };
        // -----------------------------------------------------------------


        // Utility to get today's date in YYYY-MM-DD format
        const getTodayDateId = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // Get the Firestore document reference for today's balances
        const getDailyDocRef = () => {
            if (!db || !userId) return null;
            // Path: /artifacts/{appId}/users/{userId}/daily_balances/{todayDocumentId}
            const docPath = `/artifacts/${appId}/users/${userId}/daily_balances/${todayDocumentId}`;
            return doc(db, docPath);
        };

        // --- Utility to disable Save buttons ---
        const disableSaveButtons = () => {
            const openBtn = document.getElementById('saveOpenBtn');
            const closeBtn = document.getElementById('saveCloseBtn');
            
            openBtn.disabled = true;
            openBtn.textContent = 'Save (Offline Mode)';
            openBtn.classList.replace('bg-blue-600', 'bg-gray-400');
            openBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-400');

            closeBtn.disabled = true;
            closeBtn.textContent = 'Save (Offline Mode)';
            closeBtn.classList.replace('bg-green-600', 'bg-gray-400');
            closeBtn.classList.replace('hover:bg-green-700', 'hover:bg-gray-400');
        };

        // --- Firebase Initialization and Authentication ---
        const initFirebase = async () => {
            try {
                // Determine the configuration to use
                const configToUse = firebaseConfig || mockFirebaseConfig;

                // Check if the real configuration from the Canvas environment exists
                if (firebaseConfig) {
                    isDatabaseReady = true;
                }
                
                if (!configToUse || !configToUse.apiKey) {
                    throw new Error("Firebase configuration is completely missing.");
                }

                const app = initializeApp(configToUse);
                db = getFirestore(app);
                auth = getAuth(app);
                todayDocumentId = getTodayDateId();
                document.getElementById('current-date').textContent = todayDocumentId;
                
                if (isDatabaseReady) {
                    // Only run auth and data loading if the database is confirmed available (i.e., in Canvas)
                    await new Promise((resolve) => {
                        onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                userId = user.uid;
                            } else {
                                try {
                                    if (initialAuthToken) {
                                        await signInWithCustomToken(auth, initialAuthToken);
                                    } else {
                                        await signInAnonymously(auth);
                                    }
                                    userId = auth.currentUser.uid;
                                } catch (error) {
                                    console.error("Authentication failed:", error);
                                    userId = crypto.randomUUID(); 
                                }
                            }
                            document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                            resolve();
                        });
                    });
                    await loadBalances();
                } else {
                    // Running standalone (GitHub Pages): Display message and disable save functions
                    document.getElementById('status-message').textContent = 'Calculation mode enabled. Data saving is disabled in this hosted environment.';
                    document.getElementById('user-id-display').textContent = 'User ID: N/A (Offline)';
                    disableSaveButtons();
                }

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                document.getElementById('status-message').textContent = `Initialization Error. Calculations only available.`;
                disableSaveButtons();
            }
        };

        // --- Data Loading and UI Update (Now only runs if isDatabaseReady is true) ---
        const loadBalances = async () => {
            const docRef = getDailyDocRef();
            if (!docRef) {
                console.log("Database not ready.");
                return;
            }

            try {
                document.getElementById('status-message').textContent = 'Loading today\'s balances...';
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('status-message').textContent = 'Balances loaded.';

                    // Load Opening Balances
                    document.getElementById('airtelOpen').value = data.airtelOpen || '';
                    document.getElementById('mpambaOpen').value = data.mpambaOpen || '';
                    document.getElementById('cashOpen').value = data.cashOpen || '';

                    // Load Closing Balances and Commission
                    document.getElementById('airtelClose').value = data.airtelClose || '';
                    document.getElementById('mpambaClose').value = data.mpambaClose || '';
                    document.getElementById('cashClose').value = data.cashClose || '';
                    document.getElementById('commissionEarned').value = data.commissionEarned || ''; 
                    
                    // Run calculation if closing balances are present
                    if (data.airtelClose && data.mpambaClose && data.cashClose) {
                        calculateReconciliation();
                    } else {
                        document.getElementById('reconciliation-results').classList.add('hidden');
                    }

                } else {
                    document.getElementById('status-message').textContent = 'No record found for today. Enter opening balances.';
                    document.getElementById('reconciliation-results').classList.add('hidden');
                }
            } catch (error) {
                console.error("Error loading balances:", error);
                document.getElementById('status-message').textContent = 'Error loading data from database.';
            }
        };


        // --- Saving Functions (Now checks if isDatabaseReady is true) ---
        const saveOpeningBalances = async () => {
            if (!isDatabaseReady) {
                showMessage('Database is offline. Calculations still work!', 'bg-yellow-100 text-yellow-700');
                return;
            }

            const airtelOpen = parseFloat(document.getElementById('airtelOpen').value) || 0;
            const mpambaOpen = parseFloat(document.getElementById('mpambaOpen').value) || 0;
            const cashOpen = parseFloat(document.getElementById('cashOpen').value) || 0;

            if (airtelOpen === 0 && mpambaOpen === 0 && cashOpen === 0) {
                 showMessage('Please enter at least one non-zero opening balance.', 'bg-red-100 text-red-700');
                 return;
            }

            const docRef = getDailyDocRef();
            if (!docRef) return;

            try {
                await setDoc(docRef, {
                    airtelOpen,
                    mpambaOpen,
                    cashOpen,
                    userId,
                    date: todayDocumentId
                }, { merge: true });

                showMessage('Opening balances saved successfully!', 'bg-green-100 text-green-700');
            } catch (error) {
                console.error("Error saving opening balances:", error);
                showMessage('Failed to save opening balances. Check console.', 'bg-red-100 text-red-700');
            }
        };

        const saveClosingBalances = async () => {
             if (!isDatabaseReady) {
                showMessage('Database is offline. Calculations still work!', 'bg-yellow-100 text-yellow-700');
                return;
            }
            
            const airtelClose = parseFloat(document.getElementById('airtelClose').value) || 0;
            const mpambaClose = parseFloat(document.getElementById('mpambaClose').value) || 0;
            const cashClose = parseFloat(document.getElementById('cashClose').value) || 0;
            const commissionEarned = parseFloat(document.getElementById('commissionEarned').value) || 0;

            // Check if balances were actually entered
            if (airtelClose === 0 && mpambaClose === 0 && cashClose === 0) {
                 showMessage('Please enter at least one non-zero closing balance.', 'bg-red-100 text-red-700');
                 return;
            }

            const docRef = getDailyDocRef();
            if (!docRef) return;

            try {
                await setDoc(docRef, {
                    airtelClose,
                    mpambaClose,
                    cashClose,
                    commissionEarned 
                }, { merge: true });

                showMessage('Closing balances saved!', 'bg-green-100 text-green-700');
                
            } catch (error) {
                console.error("Error saving closing balances:", error);
                showMessage('Failed to save closing balances. Check console.', 'bg-red-100 text-red-700');
            }
        };

        // --- Reconciliation Logic (No change, works offline) ---
        const calculateReconciliation = () => {
            // Get all input values (safely parsing to float or defaulting to 0)
            const airtelOpen = parseFloat(document.getElementById('airtelOpen').value) || 0;
            const mpambaOpen = parseFloat(document.getElementById('mpambaOpen').value) || 0;
            const cashOpen = parseFloat(document.getElementById('cashOpen').value) || 0;

            const airtelClose = parseFloat(document.getElementById('airtelClose').value) || 0;
            const mpambaClose = parseFloat(document.getElementById('mpambaClose').value) || 0;
            const cashClose = parseFloat(document.getElementById('cashClose').value) || 0;
            const commissionEarned = parseFloat(document.getElementById('commissionEarned').value) || 0; 

            // Basic validation check
            if ((!airtelOpen && !mpambaOpen && !cashOpen) || (!airtelClose && !mpambaClose && !cashClose)) {
                showMessage('Please enter values in both Opening and Closing Balances.', 'bg-yellow-100 text-yellow-700');
                document.getElementById('reconciliation-results').classList.add('hidden');
                return;
            }
            
            // 1. Calculate Net Float Change
            const airtelNetChange = airtelClose - airtelOpen;
            const mpambaNetChange = mpambaClose - mpambaOpen;
            const totalFloatChange = airtelNetChange + mpambaNetChange;

            // 2. Calculate Net Cash Change (What actually happened to the cash box)
            const cashNetChange = cashClose - cashOpen;

            // 3. Expected Cash Change from Float Movement ONLY
            // Float loss (negative totalFloatChange) means cash gain (positive expectedCashFromFloat)
            const expectedCashFromFloat = -totalFloatChange;

            // 4. Total Expected Cash Change (Float Movement + Commission)
            const totalExpectedCashChange = expectedCashFromFloat + commissionEarned;

            // 5. Final Reconciliation (Error Margin): Difference between Actual and Total Expected
            // This isolates the pure error/shortage/unaccounted surplus.
            const errorMargin = cashNetChange - totalExpectedCashChange; 

            // --- Display Results ---
            
            // Helper function to safely update an element's text content
            const safeUpdate = (id, value) => {
                const el = document.getElementById(id);
                if (el) { el.textContent = value; }
            };

            safeUpdate('airtel-net-change', formatCurrency(airtelNetChange));
            safeUpdate('mpamba-net-change', formatCurrency(mpambaNetChange));
            safeUpdate('total-float-change', formatCurrency(totalFloatChange));
            safeUpdate('cash-net-change', formatCurrency(cashNetChange));
            
            safeUpdate('commission-earned-display', formatCurrency(commissionEarned));
            safeUpdate('expected-cash-from-float-display', formatCurrency(expectedCashFromFloat));
            safeUpdate('total-expected-cash-change', formatCurrency(totalExpectedCashChange));

            // Set reconciliation status and color (using the errorMargin)
            const statusEl = document.getElementById('reconciliation-status');
            const statusCard = document.getElementById('reconciliation-status-card');

            if (Math.abs(errorMargin) < 0.01) { // Check for near zero (fully balanced)
                statusEl.textContent = 'Day is Fully Balanced (0 Error)';
                statusCard.className = 'p-4 rounded-xl shadow-lg bg-green-500 text-white transition-all duration-300';
            } else if (errorMargin > 0) {
                statusEl.textContent = `Unaccounted Surplus: ${formatCurrency(errorMargin)}`;
                statusCard.className = 'p-4 rounded-xl shadow-lg bg-yellow-500 text-gray-900 transition-all duration-300';
            } else {
                statusEl.textContent = `Unaccounted Shortage: ${formatCurrency(Math.abs(errorMargin))}`;
                statusCard.className = 'p-4 rounded-xl shadow-lg bg-red-500 text-white transition-all duration-300';
            }
            
            document.getElementById('reconciliation-results').classList.remove('hidden');
        };

        // --- Utility Functions ---
        const formatCurrency = (amount) => {
            // Assuming a generic currency symbol and 2 decimal places
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'MWK', // Malawian Kwacha
                minimumFractionDigits: 2
            }).format(amount);
        };

        const showMessage = (message, className) => {
            const el = document.getElementById('toast-message');
            el.textContent = message;
            el.className = `p-4 mt-4 mb-4 rounded-lg text-sm font-medium ${className}`;
            setTimeout(() => {
                el.className = 'hidden';
            }, 5000);
        };

        // --- Event Listeners ---
        window.onload = initFirebase;

        // Attach listeners to buttons
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('saveOpenBtn').addEventListener('click', saveOpeningBalances);
            document.getElementById('saveCloseBtn').addEventListener('click', saveClosingBalances);
            document.getElementById('calculateBtn').addEventListener('click', calculateReconciliation);
        });
    </script>


    <!-- Main App Container -->
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <div class="bg-white p-6 md:p-10 rounded-2xl shadow-2xl">
            <h1 class="text-3xl font-extrabold text-blue-800 mb-2">Daily Agent Reconciliation</h1>
            <p class="text-gray-500 mb-6">
                Record your start and end-of-day balances. Date: <span id="current-date" class="font-semibold">...</span>
            </p>
            <p id="user-id-display" class="text-xs text-gray-400 mb-4"></p>
            <div id="status-message" class="text-sm text-gray-500 mb-4">Initializing application...</div>
            <div id="toast-message" class="hidden"></div>


            <!-- Opening Balances Card -->
            <div class="bg-blue-50 p-6 rounded-xl mb-8 border border-blue-200">
                <h2 class="text-2xl font-bold text-blue-700 mb-4">Day Opening Balances</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="airtelOpen" class="block text-sm font-medium text-gray-700 mb-1">Airtel Money E-Value</label>
                        <input type="number" id="airtelOpen" placeholder="0.00" class="input-style" min="0">
                    </div>
                    <div>
                        <label for="mpambaOpen" class="block text-sm font-medium text-gray-700 mb-1">TNM Mpamba E-Value</label>
                        <input type="number" id="mpambaOpen" placeholder="0.00" class="input-style" min="0">
                    </div>
                    <div>
                        <label for="cashOpen" class="block text-sm font-medium text-gray-700 mb-1">Available Cash</label>
                        <input type="number" id="cashOpen" placeholder="0.00" class="input-style" min="0">
                    </div>
                </div>
                <button id="saveOpenBtn" class="mt-6 w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150">
                    Save Opening Balances
                </button>
            </div>

            <!-- Closing Balances Card -->
            <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                <h2 class="text-2xl font-bold text-green-700 mb-4">Day Closing Balances & Commission</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="airtelClose" class="block text-sm font-medium text-gray-700 mb-1">Airtel Money E-Value</label>
                        <input type="number" id="airtelClose" placeholder="0.00" class="input-style" min="0">
                    </div>
                    <div>
                        <label for="mpambaClose" class="block text-sm font-medium text-gray-700 mb-1">TNM Mpamba E-Value</label>
                        <input type="number" id="mpambaClose" placeholder="0.00" class="input-style" min="0">
                    </div>
                    <div>
                        <label for="cashClose" class="block text-sm font-medium text-gray-700 mb-1">Available Cash</label>
                        <input type="number" id="cashClose" placeholder="0.00" class="input-style" min="0">
                    </div>
                </div>
                <!-- COMMISSION INPUT -->
                <div class="mt-4 max-w-sm">
                    <label for="commissionEarned" class="block text-sm font-medium text-gray-700 mb-1">Commission Earned Today (Expected Profit)</label>
                    <input type="number" id="commissionEarned" placeholder="0.00" class="input-style" min="0">
                </div>

                <button id="saveCloseBtn" class="mt-6 w-full md:w-auto px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150">
                    Save Closing Balances
                </button>
                <button id="calculateBtn" class="mt-6 w-full md:w-auto px-6 py-3 ml-0 md:ml-4 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-150">
                    Calculate Reconciliation
                </button>
            </div>

            <hr class="my-8">

            <!-- Reconciliation Results -->
            <div id="reconciliation-results" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Daily Reconciliation Summary</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Float Changes -->
                    <div class="p-5 bg-indigo-50 rounded-xl shadow-lg">
                        <p class="text-sm font-medium text-indigo-600">Airtel Net Change</p>
                        <p id="airtel-net-change" class="text-2xl font-bold text-indigo-800 mt-1">--</p>
                    </div>
                    <div class="p-5 bg-indigo-50 rounded-xl shadow-lg">
                        <p class="text-sm font-medium text-indigo-600">Mpamba Net Change</p>
                        <p id="mpamba-net-change" class="text-2xl font-bold text-indigo-800 mt-1">--</p>
                    </div>
                    <div class="p-5 bg-indigo-200 rounded-xl shadow-lg border-2 border-indigo-400">
                        <p class="text-sm font-medium text-indigo-800">Total Float Movement</p>
                        <p id="total-float-change" class="text-2xl font-extrabold text-indigo-900 mt-1">--</p>
                    </div>
                </div>

                <!-- Cash & Final Status -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="p-5 bg-yellow-50 rounded-xl shadow-lg">
                        <p class="text-sm font-medium text-yellow-600">Actual Cash Change</p>
                        <p id="cash-net-change" class="text-2xl font-bold text-yellow-800 mt-1">--</p>
                    </div>
                    <!-- Commission Earned -->
                    <div class="p-5 bg-pink-50 rounded-xl shadow-lg">
                        <p class="text-sm font-medium text-pink-600">Commission Earned (Profit)</p>
                        <p id="commission-earned-display" class="text-2xl font-bold text-pink-800 mt-1">--</p>
                    </div>
                    <!-- Expected Cash from Float Change -->
                    <div class="p-5 bg-red-50 rounded-xl shadow-lg">
                        <p class="text-sm font-medium text-red-600">Cash Expected from Float</p>
                        <p id="expected-cash-from-float-display" class="text-2xl font-bold text-red-800 mt-1">--</p>
                    </div>
                    <!-- Total Expected Cash Change -->
                    <div class="p-5 bg-purple-50 rounded-xl shadow-lg">
                        <p class="text-sm font-medium text-purple-600">Total Expected Cash Change</p>
                        <p id="total-expected-cash-change" class="text-2xl font-bold text-purple-800 mt-1">--</p>
                    </div>
                    
                    <div id="reconciliation-status-card" class="p-4 rounded-xl shadow-lg bg-gray-200 text-gray-800 transition-all duration-300 flex flex-col items-center justify-center col-span-1 md:col-span-4">
                        <p class="text-lg font-medium mb-1">FINAL RECONCILIATION STATUS</p>
                        <p id="reconciliation-status" class="text-2xl font-bold">Awaiting Calculation</p>
                    </div>
                </div>
                
                <p class="mt-4 text-sm text-gray-500 italic">
                    *The 'Total Expected Cash Change' includes your float movement and your commission. The final status reports the resulting **Unaccounted** Shortage or Surplus (the error margin).
                </p>
            </div>


        </div>
    </div>

</body>
</html>
