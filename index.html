<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Money Agent Business Manager</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .input-style {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-tab { 
            @apply px-4 py-2 rounded-lg transition-all duration-200 font-medium cursor-pointer;
        }
        .nav-tab.active { 
            @apply bg-blue-600 text-white shadow-md;
        }
        .nav-tab:not(.active) { 
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }
        .summary-card {
            @apply p-4 rounded-xl shadow-lg transition-all duration-300 hover:shadow-xl;
        }
        button:disabled {
            @apply opacity-50 cursor-not-allowed;
        }
    </style>
</head>
<body>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, where, orderBy, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level to Debug
        setLogLevel('Debug');

        // --- CONFIGURATION START ---
        const SHARED_AGENT_ID = "Accolado"; 
        const CUSTOM_APP_ID = "mobile-money-agent"; 
        const USER_PROVIDED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAVOYLcvyM6_MhU2RQTNDFnByp1Ye3q5_o",
            authDomain: "mobile-money-app-4cf66.firebaseapp.com",
            projectId: "mobile-money-app-4cf66",
            storageBucket: "mobile-money-app-4cf66.firebasestorage.app",
            messagingSenderId: "822891731705",
            appId: "1:822891731705:web:e666599c76ce413f0a6028"
        };
        // --- CONFIGURATION END ---

        // Global variables provided by the Canvas environment
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : CUSTOM_APP_ID;
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let todayDocumentId = null;
        let isDatabaseReady = false; 
        const currentDataId = SHARED_AGENT_ID; 

        // Make functions globally available
        window.switchTab = switchTab;
        window.addTransaction = addTransaction;
        window.addExpense = addExpense;
        window.setTarget = setTarget;
        window.saveOpeningBalances = saveOpeningBalances;
        window.saveClosingBalances = saveClosingBalances;
        window.calculateReconciliation = calculateReconciliation;
        window.updateCapital = updateCapital;

        // Utility to get today's date in YYYY-MM-DD format
        const getTodayDateId = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // Get the Firestore document reference for today's balances
        const getDailyDocRef = () => {
            if (!db || !currentDataId) return null;
            const currentAppId = canvasFirebaseConfig ? canvasAppId : CUSTOM_APP_ID; 
            const docPath = `/artifacts/${currentAppId}/users/${currentDataId}/daily_balances/${todayDocumentId}`;
            return doc(db, docPath);
        };

        // Get reference for capital document
        const getCapitalDocRef = () => {
            if (!db || !currentDataId) return null;
            const currentAppId = canvasFirebaseConfig ? canvasAppId : CUSTOM_APP_ID; 
            const docPath = `/artifacts/${currentAppId}/users/${currentDataId}/capital/investment`;
            return doc(db, docPath);
        };

        // Get reference for transactions collection
        const getTransactionsCollectionRef = () => {
            if (!db || !currentDataId) return null;
            const currentAppId = canvasFirebaseConfig ? canvasAppId : CUSTOM_APP_ID; 
            const collectionPath = `/artifacts/${currentAppId}/users/${currentDataId}/transactions`;
            return collection(db, collectionPath);
        };

        // Get reference for expenses collection
        const getExpensesCollectionRef = () => {
            if (!db || !currentDataId) return null;
            const currentAppId = canvasFirebaseConfig ? canvasAppId : CUSTOM_APP_ID; 
            const collectionPath = `/artifacts/${currentAppId}/users/${currentDataId}/expenses`;
            return collection(db, collectionPath);
        };

        // Get reference for targets collection
        const getTargetsCollectionRef = () => {
            if (!db || !currentDataId) return null;
            const currentAppId = canvasFirebaseConfig ? canvasAppId : CUSTOM_APP_ID; 
            const collectionPath = `/artifacts/${currentAppId}/users/${currentDataId}/targets`;
            return collection(db, collectionPath);
        };

        // --- Tab Management ---
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content and activate tab
            const tabContent = document.getElementById(`${tabName}-tab`);
            const tabButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            if (tabButton) {
                tabButton.classList.add('active');
            }
            
            // Load data for specific tabs when activated
            if (tabName === 'transactions') {
                loadTransactions();
            } else if (tabName === 'expenses') {
                loadExpenses();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            } else if (tabName === 'targets') {
                loadTargets();
            } else if (tabName === 'dashboard') {
                loadCapital();
            }
        }

        // --- Capital Management ---
        async function updateCapital() {
            if (!isDatabaseReady) {
                showMessage('Database is offline. Cannot save capital.', 'bg-yellow-100 text-yellow-700');
                return;
            }

            const totalCapital = parseFloat(document.getElementById('totalCapital').value) || 0;

            if (totalCapital <= 0) {
                showMessage('Please enter a valid capital amount.', 'bg-red-100 text-red-700');
                return;
            }

            const capitalRef = getCapitalDocRef();
            if (!capitalRef) return;

            try {
                await setDoc(capitalRef, {
                    totalCapital,
                    lastUpdated: new Date(),
                    sharedDataId: currentDataId
                }, { merge: true });

                showMessage('Capital updated successfully!', 'bg-green-100 text-green-700');
                loadCapital();
                updateDashboardSummary();
            } catch (error) {
                console.error("Error updating capital:", error);
                showMessage('Failed to update capital. Check console.', 'bg-red-100 text-red-700');
            }
        }

        const loadCapital = async () => {
            const capitalRef = getCapitalDocRef();
            if (!capitalRef) return;

            try {
                const docSnap = await getDoc(capitalRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('totalCapital').value = data.totalCapital || '';
                    document.getElementById('currentCapitalDisplay').textContent = formatCurrency(data.totalCapital || 0);
                } else {
                    document.getElementById('currentCapitalDisplay').textContent = formatCurrency(0);
                }
            } catch (error) {
                console.error("Error loading capital:", error);
            }
        };

        // --- Transaction Management ---
        async function addTransaction() {
            if (!isDatabaseReady) {
                showMessage('Database is offline. Cannot save transaction.', 'bg-yellow-100 text-yellow-700');
                return;
            }

            const type = document.getElementById('transactionType').value;
            const platform = document.getElementById('transactionPlatform').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value) || 0;
            const customerRef = document.getElementById('transactionCustomerRef').value || 'N/A';
            const notes = document.getElementById('transactionNotes').value || '';

            if (amount <= 0) {
                showMessage('Please enter a valid amount.', 'bg-red-100 text-red-700');
                return;
            }

            const transactionsRef = getTransactionsCollectionRef();
            if (!transactionsRef) return;

            try {
                await addDoc(transactionsRef, {
                    type,
                    platform,
                    amount,
                    customerRef,
                    notes,
                    timestamp: new Date(),
                    date: todayDocumentId
                });

                // Clear form
                document.getElementById('transactionForm').reset();
                showMessage('Transaction recorded successfully!', 'bg-green-100 text-green-700');
                
                // Reload transactions list
                loadTransactions();
                // Update dashboard summary
                updateDashboardSummary();
            } catch (error) {
                console.error("Error adding transaction:", error);
                showMessage('Failed to record transaction. Check console.', 'bg-red-100 text-red-700');
            }
        }

        const loadTransactions = async () => {
            const transactionsRef = getTransactionsCollectionRef();
            if (!transactionsRef) {
                console.log("Transactions collection reference is null");
                return;
            }

            try {
                const q = query(transactionsRef, orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                const transactionsList = document.getElementById('transactionsList');
                transactionsList.innerHTML = '';
                
                let totalDeposits = 0;
                let totalWithdrawals = 0;
                let totalBillPayments = 0;
                let totalCreditPurchases = 0;
                let totalSendToDealer = 0;
                
                if (querySnapshot.empty) {
                    transactionsList.innerHTML = '<div class="text-gray-500 italic text-center py-8">No transactions recorded today</div>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const transaction = document.createElement('div');
                        transaction.className = 'p-3 border-b border-gray-200';
                        
                        let typeColor = 'text-gray-600';
                        let typeIcon = 'üí≥';
                        
                        // Set colors and icons based on transaction type
                        switch(data.type) {
                            case 'deposit':
                                typeColor = 'text-green-600';
                                typeIcon = '‚¨áÔ∏è';
                                totalDeposits += data.amount;
                                break;
                            case 'withdrawal':
                                typeColor = 'text-red-600';
                                typeIcon = '‚¨ÜÔ∏è';
                                totalWithdrawals += data.amount;
                                break;
                            case 'bill_payment':
                                typeColor = 'text-purple-600';
                                typeIcon = 'üßæ';
                                totalBillPayments += data.amount;
                                break;
                            case 'credit_purchase':
                                typeColor = 'text-orange-600';
                                typeIcon = 'üõí';
                                totalCreditPurchases += data.amount;
                                break;
                            case 'send_to_dealer':
                                typeColor = 'text-blue-600';
                                typeIcon = 'ü§ù';
                                totalSendToDealer += data.amount;
                                break;
                        }
                        
                        transaction.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-medium">${typeIcon} ${data.type.replace(/_/g, ' ').toUpperCase()}</span>
                                    <span class="text-sm text-gray-500 ml-2">${data.platform} - ${data.customerRef}</span>
                                </div>
                                <div class="text-right">
                                    <div class="${typeColor} font-bold">${formatCurrency(data.amount)}</div>
                                    <div class="text-xs text-gray-500">${new Date(data.timestamp?.toDate()).toLocaleTimeString()}</div>
                                </div>
                            </div>
                            ${data.notes ? `<div class="text-sm text-gray-600 mt-1">${data.notes}</div>` : ''}
                        `;
                        
                        transactionsList.appendChild(transaction);
                    });
                }
                
                // Update summary displays
                document.getElementById('totalDeposits').textContent = formatCurrency(totalDeposits);
                document.getElementById('totalWithdrawals').textContent = formatCurrency(totalWithdrawals);
                document.getElementById('totalBillPayments').textContent = formatCurrency(totalBillPayments);
                document.getElementById('totalCreditPurchases').textContent = formatCurrency(totalCreditPurchases);
                document.getElementById('totalSendToDealer').textContent = formatCurrency(totalSendToDealer);
                
                const netFlow = totalDeposits - totalWithdrawals;
                document.getElementById('netTransactionFlow').textContent = formatCurrency(netFlow);
                
            } catch (error) {
                console.error("Error loading transactions:", error);
                document.getElementById('transactionsList').innerHTML = '<div class="text-red-500 text-center py-8">Error loading transactions: ' + error.message + '</div>';
            }
        };

        // --- Expense Management ---
        async function addExpense() {
            if (!isDatabaseReady) {
                showMessage('Database is offline. Cannot save expense.', 'bg-yellow-100 text-yellow-700');
                return;
            }

            const category = document.getElementById('expenseCategory').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const description = document.getElementById('expenseDescription').value || '';

            if (amount <= 0) {
                showMessage('Please enter a valid amount.', 'bg-red-100 text-red-700');
                return;
            }

            const expensesRef = getExpensesCollectionRef();
            if (!expensesRef) return;

            try {
                await addDoc(expensesRef, {
                    category,
                    amount,
                    description,
                    timestamp: new Date(),
                    date: todayDocumentId
                });

                document.getElementById('expenseForm').reset();
                showMessage('Expense recorded successfully!', 'bg-green-100 text-green-700');
                
                loadExpenses();
                updateDashboardSummary();
            } catch (error) {
                console.error("Error adding expense:", error);
                showMessage('Failed to record expense. Check console.', 'bg-red-100 text-red-700');
            }
        }

        const loadExpenses = async () => {
            const expensesRef = getExpensesCollectionRef();
            if (!expensesRef) return;

            try {
                const q = query(expensesRef, orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                const expensesList = document.getElementById('expensesList');
                expensesList.innerHTML = '';
                
                let totalExpenses = 0;
                const categoryTotals = {};
                
                if (querySnapshot.empty) {
                    expensesList.innerHTML = '<div class="text-gray-500 italic text-center py-8">No expenses recorded today</div>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const expense = document.createElement('div');
                        expense.className = 'p-3 border-b border-gray-200';
                        
                        expense.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-medium">${data.category}</span>
                                    <div class="text-sm text-gray-600">${data.description}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-red-600 font-bold">${formatCurrency(data.amount)}</div>
                                    <div class="text-xs text-gray-500">${new Date(data.timestamp?.toDate()).toLocaleTimeString()}</div>
                                </div>
                            </div>
                        `;
                        
                        expensesList.appendChild(expense);
                        
                        // Calculate totals
                        totalExpenses += data.amount;
                        categoryTotals[data.category] = (categoryTotals[data.category] || 0) + data.amount;
                    });
                }
                
                document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
                
                // Update category breakdown
                const categoryBreakdown = document.getElementById('categoryBreakdown');
                categoryBreakdown.innerHTML = '';
                
                if (Object.keys(categoryTotals).length === 0) {
                    categoryBreakdown.innerHTML = '<div class="text-sm text-gray-500 italic">No expenses recorded today</div>';
                } else {
                    Object.entries(categoryTotals).forEach(([category, total]) => {
                        const categoryEl = document.createElement('div');
                        categoryEl.className = 'flex justify-between py-1';
                        categoryEl.innerHTML = `
                            <span class="text-sm">${category}</span>
                            <span class="text-sm font-medium">${formatCurrency(total)}</span>
                        `;
                        categoryBreakdown.appendChild(categoryEl);
                    });
                }
                
            } catch (error) {
                console.error("Error loading expenses:", error);
                document.getElementById('expensesList').innerHTML = '<div class="text-red-500 text-center py-8">Error loading expenses</div>';
            }
        };

        // --- Targets Management ---
        async function setTarget() {
            if (!isDatabaseReady) {
                showMessage('Database is offline. Cannot save target.', 'bg-yellow-100 text-yellow-700');
                return;
            }

            const type = document.getElementById('targetType').value;
            const amount = parseFloat(document.getElementById('targetAmount').value) || 0;
            const period = document.getElementById('targetPeriod').value;

            if (amount <= 0) {
                showMessage('Please enter a valid target amount.', 'bg-red-100 text-red-700');
                return;
            }

            const targetsRef = getTargetsCollectionRef();
            if (!targetsRef) return;

            try {
                await addDoc(targetsRef, {
                    type,
                    amount,
                    period,
                    timestamp: new Date(),
                    isActive: true
                });

                document.getElementById('targetForm').reset();
                showMessage('Target set successfully!', 'bg-green-100 text-green-700');
                
                loadTargets();
            } catch (error) {
                console.error("Error setting target:", error);
                showMessage('Failed to set target. Check console.', 'bg-red-100 text-red-700');
            }
        }

        const loadTargets = async () => {
            const targetsRef = getTargetsCollectionRef();
            if (!targetsRef) return;

            try {
                const q = query(targetsRef, orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                const targetsList = document.getElementById('targetsList');
                targetsList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    targetsList.innerHTML = '<div class="text-gray-500 italic text-center py-8">No active targets set</div>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const target = document.createElement('div');
                        target.className = 'p-4 border border-gray-300 rounded-lg mb-3';
                        
                        // Calculate progress (this would need actual data comparison)
                        const progress = 0; // Placeholder - you'd need to compare with actual performance
                        
                        target.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-blue-700">${data.type} Target</span>
                                <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">${data.period}</span>
                            </div>
                            <div class="mb-2">
                                <div class="flex justify-between text-sm mb-1">
                                    <span>Target: ${formatCurrency(data.amount)}</span>
                                    <span>Progress: ${progress}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">
                                Set on: ${new Date(data.timestamp?.toDate()).toLocaleDateString()}
                            </div>
                        `;
                        
                        targetsList.appendChild(target);
                    });
                }
                
            } catch (error) {
                console.error("Error loading targets:", error);
                document.getElementById('targetsList').innerHTML = '<div class="text-red-500 text-center py-8">Error loading targets</div>';
            }
        };

        // --- Analytics Dashboard ---
        const loadAnalytics = async () => {
            updateDashboardSummary();
        };

        const updateDashboardSummary = async () => {
            try {
                // Load current balances
                const docRef = getDailyDocRef();
                if (docRef) {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const currentBalance = (data.cashClose || 0) + (data.airtelClose || 0) + (data.mpambaClose || 0);
                        document.getElementById('currentBalance').textContent = formatCurrency(currentBalance);
                        
                        // Load capital
                        const capitalRef = getCapitalDocRef();
                        if (capitalRef) {
                            const capitalSnap = await getDoc(capitalRef);
                            if (capitalSnap.exists()) {
                                const capitalData = capitalSnap.data();
                                const investedCapital = capitalData.totalCapital || 0;
                                const shortageSurplus = currentBalance - investedCapital;
                                
                                document.getElementById('investedCapital').textContent = formatCurrency(investedCapital);
                                document.getElementById('shortageSurplus').textContent = formatCurrency(shortageSurplus);
                                
                                const shortageElement = document.getElementById('shortageSurplus');
                                if (shortageSurplus >= 0) {
                                    shortageElement.className = 'text-2xl font-bold text-green-800 mt-1';
                                } else {
                                    shortageElement.className = 'text-2xl font-bold text-red-800 mt-1';
                                }
                            }
                        }
                    }
                }
                
                document.getElementById('businessHealth').textContent = "Good";
                document.getElementById('dailyVolume').textContent = "Calculating...";
            } catch (error) {
                console.error("Error updating dashboard:", error);
            }
        };

        // --- Existing Functions (with minor updates) ---
        const enableSaveButtons = () => {
            const openBtn = document.getElementById('saveOpenBtn');
            const closeBtn = document.getElementById('saveCloseBtn');
            
            if (openBtn) {
                openBtn.disabled = false;
                openBtn.textContent = 'Save Opening Balances';
                openBtn.classList.replace('bg-gray-400', 'bg-blue-600');
                openBtn.classList.replace('hover:bg-gray-400', 'hover:bg-blue-700');
            }

            if (closeBtn) {
                closeBtn.disabled = false;
                closeBtn.textContent = 'Save Closing Balances';
                closeBtn.classList.replace('bg-gray-400', 'bg-green-600');
                closeBtn.classList.replace('hover:bg-gray-400', 'hover:bg-green-700');
            }
        };

        const disableSaveButtons = () => {
            const openBtn = document.getElementById('saveOpenBtn');
            const closeBtn = document.getElementById('saveCloseBtn');
            
            if (openBtn) {
                openBtn.disabled = true;
                openBtn.textContent = 'Save (Offline Mode)';
                openBtn.classList.replace('bg-blue-600', 'bg-gray-400');
                openBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-400');
            }

            if (closeBtn) {
                closeBtn.disabled = true;
                closeBtn.textContent = 'Save (Offline Mode)';
                closeBtn.classList.replace('bg-green-600', 'bg-gray-400');
                closeBtn.classList.replace('hover:bg-green-700', 'hover:bg-gray-400');
            }
        };

        const initFirebase = async () => {
            let configToUse = null;

            if (canvasFirebaseConfig) {
                configToUse = canvasFirebaseConfig;
                isDatabaseReady = true;
                document.getElementById('status-message').textContent = 'Canvas Environment: Database Active.';
            } 
            else if (USER_PROVIDED_FIREBASE_CONFIG.apiKey) {
                configToUse = USER_PROVIDED_FIREBASE_CONFIG;
                isDatabaseReady = true;
                document.getElementById('status-message').textContent = 'Self-Hosted Mode: Database Active.';
            } 
            else {
                document.getElementById('status-message').textContent = 'Calculation mode enabled. Data saving is disabled (Missing Firebase keys).';
                document.getElementById('data-id-display').textContent = 'Data ID (Shared): N/A (Offline)';
                disableSaveButtons();
                return;
            }
            
            try {
                const app = initializeApp(configToUse);
                db = getFirestore(app);
                auth = getAuth(app);
                todayDocumentId = getTodayDateId();
                document.getElementById('current-date').textContent = todayDocumentId;
                document.getElementById('data-id-display').textContent = `Data ID (Shared): ${currentDataId}`; 

                try {
                    if (initialAuthToken && canvasFirebaseConfig) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with Custom Token successfully.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously successfully.");
                    }
                    enableSaveButtons();
                    
                    await loadBalances();
                    await loadCapital();
                    updateDashboardSummary();
                } catch (error) {
                    console.error("Authentication failed before loading data:", error.code, error.message);
                    document.getElementById('status-message').textContent = `Authentication failed. Calculations only available.`;
                    disableSaveButtons();
                    return; 
                }

            } catch (error) {
                console.error("Failed to initialize Firebase:", error.code, error.message); 
                document.getElementById('status-message').textContent = `Initialization Error. Calculations only available.`;
                disableSaveButtons();
            }
        };

        const loadBalances = async () => {
            const docRef = getDailyDocRef();
            if (!docRef) {
                console.log("Database not ready for loading.");
                return;
            }

            try {
                document.getElementById('status-message').textContent = 'Loading today\'s balances...';
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('status-message').textContent = 'Balances loaded.';

                    document.getElementById('airtelOpen').value = data.airtelOpen || '';
                    document.getElementById('mpambaOpen').value = data.mpambaOpen || '';
                    document.getElementById('cashOpen').value = data.cashOpen || '';

                    document.getElementById('airtelClose').value = data.airtelClose || '';
                    document.getElementById('mpambaClose').value = data.mpambaClose || '';
                    document.getElementById('cashClose').value = data.cashClose || '';
                    document.getElementById('commissionEarned').value = data.commissionEarned || ''; 
                    
                    if (data.airtelClose && data.mpambaClose && data.cashClose) {
                        calculateReconciliation();
                    } else {
                        document.getElementById('reconciliation-results').classList.add('hidden');
                    }

                } else {
                    document.getElementById('status-message').textContent = 'No record found for today. Enter opening balances.';
                    document.getElementById('reconciliation-results').classList.add('hidden');
                }
            } catch (error) {
                console.error("Error loading balances:", error);
                document.getElementById('status-message').textContent = `Error loading data. Check Firestore Rules! We need access to /artifacts/{appId}/users/${SHARED_AGENT_ID}/...`;
            }
        };

        async function saveOpeningBalances() {
            if (!isDatabaseReady) {
                showMessage('Database is offline. Calculations still work!', 'bg-yellow-100 text-yellow-700');
                return;
            }

            const airtelOpen = parseFloat(document.getElementById('airtelOpen').value) || 0;
            const mpambaOpen = parseFloat(document.getElementById('mpambaOpen').value) || 0;
            const cashOpen = parseFloat(document.getElementById('cashOpen').value) || 0;

            if (airtelOpen === 0 && mpambaOpen === 0 && cashOpen === 0) {
                 showMessage('Please enter at least one non-zero opening balance.', 'bg-red-100 text-red-700');
                 return;
            }

            const docRef = getDailyDocRef();
            if (!docRef) return;

            try {
                await setDoc(docRef, {
                    airtelOpen,
                    mpambaOpen,
                    cashOpen,
                    sharedDataId: currentDataId, 
                    date: todayDocumentId
                }, { merge: true });

                showMessage('Opening balances saved successfully!', 'bg-green-100 text-green-700');
            } catch (error) {
                console.error("Error saving opening balances:", error);
                showMessage('Failed to save opening balances. Check console.', 'bg-red-100 text-red-700');
            }
        }

        async function saveClosingBalances() {
             if (!isDatabaseReady) {
                showMessage('Database is offline. Calculations still work!', 'bg-yellow-100 text-yellow-700');
                return;
            }
            
            const airtelClose = parseFloat(document.getElementById('airtelClose').value) || 0;
            const mpambaClose = parseFloat(document.getElementById('mpambaClose').value) || 0;
            const cashClose = parseFloat(document.getElementById('cashClose').value) || 0;
            const commissionEarned = parseFloat(document.getElementById('commissionEarned').value) || 0;

            if (airtelClose === 0 && mpambaClose === 0 && cashClose === 0) {
                 showMessage('Please enter at least one non-zero closing balance.', 'bg-red-100 text-red-700');
                 return;
            }

            const docRef = getDailyDocRef();
            if (!docRef) return;

            try {
                await setDoc(docRef, {
                    airtelClose,
                    mpambaClose,
                    cashClose,
                    commissionEarned 
                }, { merge: true });

                showMessage('Closing balances saved!', 'bg-green-100 text-green-700');
                
            } catch (error) {
                console.error("Error saving closing balances:", error);
                showMessage('Failed to save closing balances. Check console.', 'bg-red-100 text-red-700');
            }
        }

        function calculateReconciliation() {
            const airtelOpen = parseFloat(document.getElementById('airtelOpen').value) || 0;
            const mpambaOpen = parseFloat(document.getElementById('mpambaOpen').value) || 0;
            const cashOpen = parseFloat(document.getElementById('cashOpen').value) || 0;

            const airtelClose = parseFloat(document.getElementById('airtelClose').value) || 0;
            const mpambaClose = parseFloat(document.getElementById('mpambaClose').value) || 0;
            const cashClose = parseFloat(document.getElementById('cashClose').value) || 0;
            const commissionEarned = parseFloat(document.getElementById('commissionEarned').value) || 0; 

            if ((!airtelOpen && !mpambaOpen && !cashOpen) || (!airtelClose && !mpambaClose && !cashClose)) {
                showMessage('Please enter values in both Opening and Closing Balances.', 'bg-yellow-100 text-yellow-700');
                document.getElementById('reconciliation-results').classList.add('hidden');
                return;
            }
            
            const airtelNetChange = airtelClose - airtelOpen;
            const mpambaNetChange = mpambaClose - mpambaOpen;
            const totalFloatChange = airtelNetChange + mpambaNetChange;

            const cashNetChange = cashClose - cashOpen;
            const expectedCashFromFloat = -totalFloatChange;
            const totalExpectedCashChange = expectedCashFromFloat + commissionEarned;
            
            // NEW: Calculate final reconciliation including commission
            const finalReconciliation = cashNetChange - totalExpectedCashChange;
            const balanceAfterCommission = finalReconciliation - commissionEarned;

            const safeUpdate = (id, value) => {
                const el = document.getElementById(id);
                if (el) { el.textContent = value; }
            };

            safeUpdate('airtel-net-change', formatCurrency(airtelNetChange));
            safeUpdate('mpamba-net-change', formatCurrency(mpambaNetChange));
            safeUpdate('total-float-change', formatCurrency(totalFloatChange));
            safeUpdate('cash-net-change', formatCurrency(cashNetChange));
            
            safeUpdate('commission-earned-display', formatCurrency(commissionEarned));
            safeUpdate('expected-cash-from-float-display', formatCurrency(expectedCashFromFloat));
            safeUpdate('total-expected-cash-change', formatCurrency(totalExpectedCashChange));
            safeUpdate('balance-after-commission', formatCurrency(balanceAfterCommission));

            const statusEl = document.getElementById('reconciliation-status');
            const statusCard = document.getElementById('reconciliation-status-card');

            // Updated logic to include commission in final calculation
            const finalAmount = balanceAfterCommission;
            
            if (Math.abs(finalAmount) < 0.01) {
                statusEl.textContent = 'Day is Fully Balanced (0 Error)';
                statusCard.className = 'p-4 rounded-xl shadow-lg bg-green-500 text-white transition-all duration-300 flex flex-col items-center justify-center col-span-1 md:col-span-4';
            } else if (finalAmount > 0) {
                statusEl.textContent = `Unaccounted Surplus: ${formatCurrency(finalAmount)}`;
                statusCard.className = 'p-4 rounded-xl shadow-lg bg-yellow-500 text-gray-900 transition-all duration-300 flex flex-col items-center justify-center col-span-1 md:col-span-4';
            } else {
                statusEl.textContent = `Unaccounted Shortage: ${formatCurrency(Math.abs(finalAmount))}`;
                statusCard.className = 'p-4 rounded-xl shadow-lg bg-red-500 text-white transition-all duration-300 flex flex-col items-center justify-center col-span-1 md:col-span-4';
            }
            
            document.getElementById('reconciliation-results').classList.remove('hidden');
        }

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'MWK',
                minimumFractionDigits: 2
            }).format(amount);
        };

        const showMessage = (message, className) => {
            const el = document.getElementById('toast-message');
            if (el) {
                el.textContent = message;
                el.className = `p-4 mt-4 mb-4 rounded-lg text-sm font-medium ${className}`;
                setTimeout(() => {
                    el.className = 'hidden';
                }, 5000);
            }
        };

        // --- Event Listeners ---
        window.onload = initFirebase;

        document.addEventListener('DOMContentLoaded', () => {
            // Add event listeners for buttons
            const addTransactionBtn = document.getElementById('addTransactionBtn');
            const addExpenseBtn = document.getElementById('addExpenseBtn');
            const setTargetBtn = document.getElementById('setTargetBtn');
            const saveOpenBtn = document.getElementById('saveOpenBtn');
            const saveCloseBtn = document.getElementById('saveCloseBtn');
            const calculateBtn = document.getElementById('calculateBtn');
            const updateCapitalBtn = document.getElementById('updateCapitalBtn');

            if (addTransactionBtn) {
                addTransactionBtn.addEventListener('click', addTransaction);
            }
            if (addExpenseBtn) {
                addExpenseBtn.addEventListener('click', addExpense);
            }
            if (setTargetBtn) {
                setTargetBtn.addEventListener('click', setTarget);
            }
            if (saveOpenBtn) {
                saveOpenBtn.addEventListener('click', saveOpeningBalances);
            }
            if (saveCloseBtn) {
                saveCloseBtn.addEventListener('click', saveClosingBalances);
            }
            if (calculateBtn) {
                calculateBtn.addEventListener('click', calculateReconciliation);
            }
            if (updateCapitalBtn) {
                updateCapitalBtn.addEventListener('click', updateCapital);
            }
            
            // Set default active tab
            switchTab('dashboard');
        });
    </script>


    <!-- Main App Container -->
    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <div class="bg-white p-6 md:p-10 rounded-2xl shadow-2xl">
            <h1 class="text-3xl font-extrabold text-blue-800 mb-2">Mobile Money Agent Business Manager</h1>
            <p class="text-gray-500 mb-6">
                Complete business management for your mobile money operations. Date: <span id="current-date" class="font-semibold">...</span>
            </p>
            <p id="data-id-display" class="text-sm font-medium text-purple-600 mb-4">Data ID (Shared): Accolado</p>
            
            <div id="status-message" class="text-sm text-gray-500 mb-4">Initializing application...</div>
            <div id="toast-message" class="hidden"></div>

            <!-- Navigation Tabs -->
            <div class="flex flex-wrap gap-2 mb-8 border-b pb-4">
                <button onclick="switchTab('dashboard')" class="nav-tab active">üìä Dashboard</button>
                <button onclick="switchTab('reconciliation')" class="nav-tab">üí∞ Reconciliation</button>
                <button onclick="switchTab('transactions')" class="nav-tab">üí≥ Transactions</button>
                <button onclick="switchTab('expenses')" class="nav-tab">üìã Expenses</button>
                <button onclick="switchTab('targets')" class="nav-tab">üéØ Targets</button>
                <button onclick="switchTab('analytics')" class="nav-tab">üìà Analytics</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Business Overview</h2>
                
                <!-- Capital Investment Section -->
                <div class="bg-yellow-50 p-6 rounded-xl mb-8 border border-yellow-200">
                    <h2 class="text-2xl font-bold text-yellow-700 mb-4">Capital Investment</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="totalCapital" class="block text-sm font-medium text-gray-700 mb-1">Total Invested Capital (MWK)</label>
                            <input type="number" id="totalCapital" placeholder="0.00" class="input-style" min="0">
                            <button id="updateCapitalBtn" class="mt-4 w-full md:w-auto px-6 py-3 bg-yellow-600 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-700 transition duration-150 cursor-pointer">
                                Update Capital
                            </button>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-yellow-300">
                            <h3 class="text-lg font-bold text-yellow-700 mb-2">Current Capital Status</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm">Invested Capital:</span>
                                    <span id="currentCapitalDisplay" class="font-bold text-yellow-700">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="summary-card bg-blue-50 border border-blue-200">
                        <div class="text-blue-600 text-sm font-medium">Current Balance</div>
                        <div id="currentBalance" class="text-2xl font-bold text-blue-800 mt-1">--</div>
                    </div>
                    <div class="summary-card bg-green-50 border border-green-200">
                        <div class="text-green-600 text-sm font-medium">Business Health</div>
                        <div id="businessHealth" class="text-2xl font-bold text-green-800 mt-1">--</div>
                    </div>
                    <div class="summary-card bg-purple-50 border border-purple-200">
                        <div class="text-purple-600 text-sm font-medium">Invested Capital</div>
                        <div id="investedCapital" class="text-2xl font-bold text-purple-800 mt-1">--</div>
                    </div>
                    <div class="summary-card bg-red-50 border border-red-200">
                        <div class="text-red-600 text-sm font-medium">Shortage/Surplus</div>
                        <div id="shortageSurplus" class="text-2xl font-bold text-red-800 mt-1">--</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">Quick Actions</h3>
                        <div class="space-y-3">
                            <button onclick="switchTab('reconciliation')" class="w-full text-left p-3 bg-white border border-gray-300 rounded-lg hover:bg-blue-50 transition duration-150 cursor-pointer">
                                <span class="font-medium">üí∞ Perform Daily Reconciliation</span>
                                <p class="text-sm text-gray-500 mt-1">Record opening and closing balances</p>
                            </button>
                            <button onclick="switchTab('transactions')" class="w-full text-left p-3 bg-white border border-gray-300 rounded-lg hover:bg-green-50 transition duration-150 cursor-pointer">
                                <span class="font-medium">üí≥ Record New Transaction</span>
                                <p class="text-sm text-gray-500 mt-1">Add deposit or withdrawal</p>
                            </button>
                            <button onclick="switchTab('expenses')" class="w-full text-left p-3 bg-white border border-gray-300 rounded-lg hover:bg-red-50 transition duration-150 cursor-pointer">
                                <span class="font-medium">üìã Log Business Expense</span>
                                <p class="text-sm text-gray-500 mt-1">Track operational costs</p>
                            </button>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">Recent Activity</h3>
                        <div id="recentActivity" class="space-y-3">
                            <div class="text-gray-500 italic">Activity will appear here as you use the system...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reconciliation Tab (Existing functionality) -->
            <div id="reconciliation-tab" class="tab-content">
                <!-- Opening Balances Card -->
                <div class="bg-blue-50 p-6 rounded-xl mb-8 border border-blue-200">
                    <h2 class="text-2xl font-bold text-blue-700 mb-4">Day Opening Balances</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="airtelOpen" class="block text-sm font-medium text-gray-700 mb-1">Airtel Money E-Value</label>
                            <input type="number" id="airtelOpen" placeholder="0.00" class="input-style" min="0">
                        </div>
                        <div>
                            <label for="mpambaOpen" class="block text-sm font-medium text-gray-700 mb-1">TNM Mpamba E-Value</label>
                            <input type="number" id="mpambaOpen" placeholder="0.00" class="input-style" min="0">
                        </div>
                        <div>
                            <label for="cashOpen" class="block text-sm font-medium text-gray-700 mb-1">Available Cash</label>
                            <input type="number" id="cashOpen" placeholder="0.00" class="input-style" min="0">
                        </div>
                    </div>
                    <button id="saveOpenBtn" class="mt-6 w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 cursor-pointer">
                        Save Opening Balances
                    </button>
                </div>

                <!-- Closing Balances Card -->
                <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                    <h2 class="text-2xl font-bold text-green-700 mb-4">Day Closing Balances & Commission</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="airtelClose" class="block text-sm font-medium text-gray-700 mb-1">Airtel Money E-Value</label>
                            <input type="number" id="airtelClose" placeholder="0.00" class="input-style" min="0">
                        </div>
                        <div>
                            <label for="mpambaClose" class="block text-sm font-medium text-gray-700 mb-1">TNM Mpamba E-Value</label>
                            <input type="number" id="mpambaClose" placeholder="0.00" class="input-style" min="0">
                        </div>
                        <div>
                            <label for="cashClose" class="block text-sm font-medium text-gray-700 mb-1">Available Cash</label>
                            <input type="number" id="cashClose" placeholder="0.00" class="input-style" min="0">
                        </div>
                    </div>
                    <div class="mt-4 max-w-sm">
                        <label for="commissionEarned" class="block text-sm font-medium text-gray-700 mb-1">Commission Earned Today</label>
                        <input type="number" id="commissionEarned" placeholder="0.00" class="input-style" min="0">
                    </div>

                    <button id="saveCloseBtn" class="mt-6 w-full md:w-auto px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 cursor-pointer">
                        Save Closing Balances
                    </button>
                    <button id="calculateBtn" class="mt-6 w-full md:w-auto px-6 py-3 ml-0 md:ml-4 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-150 cursor-pointer">
                        Calculate Reconciliation
                    </button>
                </div>

                <hr class="my-8">

                <!-- Reconciliation Results -->
                <div id="reconciliation-results" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Daily Reconciliation Summary</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="p-5 bg-indigo-50 rounded-xl shadow-lg">
                            <p class="text-sm font-medium text-indigo-600">Airtel Net Change</p>
                            <p id="airtel-net-change" class="text-2xl font-bold text-indigo-800 mt-1">--</p>
                        </div>
                        <div class="p-5 bg-indigo-50 rounded-xl shadow-lg">
                            <p class="text-sm font-medium text-indigo-600">Mpamba Net Change</p>
                            <p id="mpamba-net-change" class="text-2xl font-bold text-indigo-800 mt-1">--</p>
                        </div>
                        <div class="p-5 bg-indigo-200 rounded-xl shadow-lg border-2 border-indigo-400">
                            <p class="text-sm font-medium text-indigo-800">Total Float Movement</p>
                            <p id="total-float-change" class="text-2xl font-extrabold text-indigo-900 mt-1">--</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="p-5 bg-yellow-50 rounded-xl shadow-lg">
                            <p class="text-sm font-medium text-yellow-600">Actual Cash Change</p>
                            <p id="cash-net-change" class="text-2xl font-bold text-yellow-800 mt-1">--</p>
                        </div>
                        <div class="p-5 bg-pink-50 rounded-xl shadow-lg">
                            <p class="text-sm font-medium text-pink-600">Commission Earned</p>
                            <p id="commission-earned-display" class="text-2xl font-bold text-pink-800 mt-1">--</p>
                        </div>
                        <div class="p-5 bg-red-50 rounded-xl shadow-lg">
                            <p class="text-sm font-medium text-red-600">Cash Expected from Float</p>
                            <p id="expected-cash-from-float-display" class="text-2xl font-bold text-red-800 mt-1">--</p>
                        </div>
                        <div class="p-5 bg-purple-50 rounded-xl shadow-lg">
                            <p class="text-sm font-medium text-purple-600">Total Expected Cash Change</p>
                            <p id="total-expected-cash-change" class="text-2xl font-bold text-purple-800 mt-1">--</p>
                        </div>
                    </div>

                    <!-- NEW: Balance After Commission -->
                    <div class="mt-6 grid grid-cols-1">
                        <div class="p-5 bg-orange-50 rounded-xl shadow-lg border-2 border-orange-400">
                            <p class="text-sm font-medium text-orange-800">Balance After Commission Deduction</p>
                            <p id="balance-after-commission" class="text-2xl font-extrabold text-orange-900 mt-1">--</p>
                        </div>
                    </div>
                        
                    <div id="reconciliation-status-card" class="mt-6 p-4 rounded-xl shadow-lg bg-gray-200 text-gray-800 transition-all duration-300 flex flex-col items-center justify-center">
                        <p class="text-lg font-medium mb-1">FINAL RECONCILIATION STATUS</p>
                        <p id="reconciliation-status" class="text-2xl font-bold">Awaiting Calculation</p>
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions-tab" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Transaction Management</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl border border-gray-300 shadow-sm">
                            <h3 class="text-lg font-bold text-gray-700 mb-4">Record New Transaction</h3>
                            <form id="transactionForm">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Type</label>
                                        <select id="transactionType" class="input-style">
                                            <option value="deposit">Cash Deposit</option>
                                            <option value="withdrawal">Cash Withdrawal</option>
                                            <option value="bill_payment">Bill Payment</option>
                                            <option value="credit_purchase">Credit Purchase</option>
                                            <option value="send_to_dealer">Send to Dealer</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Platform</label>
                                        <select id="transactionPlatform" class="input-style">
                                            <option value="Airtel Money">Airtel Money</option>
                                            <option value="TNM Mpamba">TNM Mpamba</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Amount (MWK)</label>
                                        <input type="number" id="transactionAmount" class="input-style" placeholder="0.00" min="0" step="0.01" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer Reference</label>
                                        <input type="text" id="transactionCustomerRef" class="input-style" placeholder="Optional customer ID or phone">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                        <textarea id="transactionNotes" class="input-style" placeholder="Additional notes (optional)" rows="2"></textarea>
                                    </div>
                                    <button type="button" id="addTransactionBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 cursor-pointer">
                                        Record Transaction
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="mt-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <h4 class="font-bold text-gray-700 mb-3">Today's Summary</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm">Total Deposits:</span>
                                    <span id="totalDeposits" class="font-medium text-green-600">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Total Withdrawals:</span>
                                    <span id="totalWithdrawals" class="font-medium text-red-600">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Bill Payments:</span>
                                    <span id="totalBillPayments" class="font-medium text-purple-600">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Credit Purchases:</span>
                                    <span id="totalCreditPurchases" class="font-medium text-orange-600">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Send to Dealer:</span>
                                    <span id="totalSendToDealer" class="font-medium text-blue-600">--</span>
                                </div>
                                <div class="flex justify-between border-t pt-2">
                                    <span class="text-sm font-medium">Net Flow:</span>
                                    <span id="netTransactionFlow" class="font-bold">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <div class="bg-white p-6 rounded-xl border border-gray-300 shadow-sm">
                            <h3 class="text-lg font-bold text-gray-700 mb-4">Recent Transactions</h3>
                            <div id="transactionsList" class="max-h-96 overflow-y-auto">
                                <div class="text-gray-500 italic text-center py-8">No transactions recorded today</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expenses-tab" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Expense Tracking</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl border border-gray-300 shadow-sm">
                            <h3 class="text-lg font-bold text-gray-700 mb-4">Record New Expense</h3>
                            <form id="expenseForm">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Expense Category</label>
                                        <select id="expenseCategory" class="input-style">
                                            <option value="Transport">Transport</option>
                                            <option value="Airtime/Data">Airtime/Data</option>
                                            <option value="Food">Food</option>
                                            <option value="Rent">Rent</option>
                                            <option value="Utilities">Utilities</option>
                                            <option value="Supplies">Supplies</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Amount (MWK)</label>
                                        <input type="number" id="expenseAmount" class="input-style" placeholder="0.00" min="0" step="0.01" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                        <textarea id="expenseDescription" class="input-style" placeholder="What was this expense for?" rows="3"></textarea>
                                    </div>
                                    <button type="button" id="addExpenseBtn" class="w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition duration-150 cursor-pointer">
                                        Record Expense
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="mt-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <h4 class="font-bold text-gray-700 mb-3">Expense Breakdown</h4>
                            <div id="categoryBreakdown">
                                <div class="text-sm text-gray-500 italic">No expenses recorded today</div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <div class="bg-white p-6 rounded-xl border border-gray-300 shadow-sm">
                            <h3 class="text-lg font-bold text-gray-700 mb-4">Recent Expenses</h3>
                            <div id="expensesList" class="max-h-96 overflow-y-auto">
                                <div class="text-gray-500 italic text-center py-8">No expenses recorded today</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Targets Tab -->
            <div id="targets-tab" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Business Targets & Goals</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl border border-gray-300 shadow-sm">
                            <h3 class="text-lg font-bold text-gray-700 mb-4">Set New Target</h3>
                            <form id="targetForm">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Target Type</label>
                                        <select id="targetType" class="input-style">
                                            <option value="Daily Commission">Daily Commission</option>
                                            <option value="Transaction Volume">Transaction Volume</option>
                                            <option value="Customer Growth">Customer Growth</option>
                                            <option value="Revenue">Revenue</option>
                                            <option value="Expense Reduction">Expense Reduction</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Target Amount (MWK)</label>
                                        <input type="number" id="targetAmount" class="input-style" placeholder="0.00" min="0" step="0.01" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Time Period</label>
                                        <select id="targetPeriod" class="input-style">
                                            <option value="Daily">Daily</option>
                                            <option value="Weekly">Weekly</option>
                                            <option value="Monthly">Monthly</option>
                                            <option value="Quarterly">Quarterly</option>
                                        </select>
                                    </div>
                                    <button type="button" id="setTargetBtn" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-150 cursor-pointer">
                                        Set Target
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <div class="bg-white p-6 rounded-xl border border-gray-300 shadow-sm">
                            <h3 class="text-lg font-bold text-gray-700 mb-4">Active Targets</h3>
                            <div id="targetsList" class="space-y-4">
                                <div class="text-gray-500 italic text-center py-8">No active targets set</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Business Analytics</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl border border-gray-300 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">Performance Metrics</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="font-medium">Daily Average Commission</span>
                                <span class="text-blue-600 font-bold">--</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="font-medium">Transaction Success Rate</span>
                                <span class="text-green-600 font-bold">--</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="font-medium">Expense to Revenue Ratio</span>
                                <span class="text-red-600 font-bold">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl border border-gray-300 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">Platform Performance</h3>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm">Airtel Money Volume</span>
                                    <span class="text-sm font-medium">--</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: 50%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm">TNM Mpamba Volume</span>
                                    <span class="text-sm font-medium">--</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-600 h-2 rounded-full" style="width: 50%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 bg-white p-6 rounded-xl border border-gray-300 shadow-sm">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">Business Insights</h3>
                    <div class="text-gray-500 italic">
                        Analytics and insights will appear here as you collect more data. Track your performance over time to identify trends and opportunities for growth.
                    </div>
                </div>
            </div>

        </div>
    </div>

</body>
</html>
